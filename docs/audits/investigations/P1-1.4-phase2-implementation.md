# P1 1.4 Phase 2 – Chart Body Height Calculation Implementation

**Date:** 2026-01-10T12:22:53.300Z  
**Status:** Phase 2 Complete  
**Investigator:** Tribeca  
**Reference:** `P1-1.4-deterministic-height-resolution-solutions.md`

---

## Phase 2 Goal

Calculate chart body height explicitly instead of using flex growth. Replace `flex: 1` with explicit height calculation: `containerHeight - headerHeight - padding`.

---

## Changes Implemented

### 1. Bar Chart Height Calculation

**File:** `app/report/[slug]/ReportChart.tsx:437-494`

**Added:**
- Ref for chart body (`chartBodyRef`) to access DOM element
- `useEffect` hook that:
  - Finds parent CellWrapper container (chart container)
  - Measures container height (`offsetHeight`)
  - Measures title zone height (if exists)
  - Measures subtitle zone height (if exists)
  - Calculates body zone height: `containerHeight - titleHeight - subtitleHeight`
  - Sets CSS custom property `--chart-body-height` on chart container
  - Uses `ResizeObserver` to recalculate on resize

**Rationale:** Explicit height calculation replaces implicit flex growth, ensuring deterministic behavior.

### 2. Body Zone CSS Update

**File:** `components/CellWrapper.module.css:66-76`

**Before:**
```css
.bodyZone {
  flex: 1;
  ...
}
```

**After:**
```css
.bodyZone {
  height: var(--chart-body-height, auto); /* WHAT: Use calculated body height, fallback to auto for backward compatibility */
  ...
}
```

**Rationale:** Replaced `flex: 1` with explicit height from CSS custom property. Fallback to `auto` maintains backward compatibility for charts not yet updated.

### 3. Chart Body CSS Update (BAR)

**File:** `app/report/[slug]/ReportChart.module.css:370-381`

**Before:**
```css
.bar .chartBody {
  flex: 1;
  ...
}
```

**After:**
```css
.bar .chartBody {
  height: 100%; /* WHAT: Fill parent body zone height (explicit height from --chart-body-height) */
  ...
}
```

**Rationale:** Chart body now uses explicit height (`100%` of body zone) instead of flex growth.

---

## Implementation Details

### Height Calculation Logic

1. **Container Height:** Measured from CellWrapper's `offsetHeight` (set via `--block-height` from row)
2. **Title Zone Height:** Measured from title zone element's `offsetHeight` (if exists)
3. **Subtitle Zone Height:** Measured from subtitle zone element's `offsetHeight` (if exists)
4. **Body Zone Height:** Calculated as `containerHeight - titleHeight - subtitleHeight`
5. **CSS Custom Property:** Set as `--chart-body-height` on chart container (CellWrapper)

### ResizeObserver Integration

- Observes chart container for size changes
- Recalculates body height on resize
- Cleans up observer on component unmount

### Backward Compatibility

- Body zone CSS uses `var(--chart-body-height, auto)` fallback
- If CSS variable is not set, falls back to `auto` (original behavior)
- Ensures charts without height calculation still work

---

## Acceptance Criteria Verification

### ✅ Chart body height is calculated explicitly
- BAR chart calculates body zone height: `containerHeight - titleHeight - subtitleHeight`
- Height calculation runs on mount and resize

### ✅ No `flex: 1` without explicit height constraint
- `.bodyZone` now uses `height: var(--chart-body-height, auto)` instead of `flex: 1`
- `.bar .chartBody` now uses `height: 100%` instead of `flex: 1`

### ✅ All chart types use explicit height
- **BAR:** ✅ Implemented (Phase 2)
- **TABLE:** ⏳ Not yet implemented (uses CellWrapper, body zone updated)
- **IMAGE:** ⏳ Not yet implemented (uses CellWrapper, body zone updated)
- **PIE:** ⏳ Not yet implemented (doesn't use CellWrapper, different structure)
- **TEXT:** ⏳ Not yet implemented (doesn't use CellWrapper, different structure)
- **KPI:** ⏳ Not yet implemented (doesn't use CellWrapper, uses grid layout)

**Note:** Phase 2 scope is limited to BAR charts as they use `.chartBody` within CellWrapper. Other chart types will be handled in subsequent phases.

---

## Local Gate Results

**Build:** ✅ Pass  
**Linting:** ✅ No errors  
**TypeScript:** ✅ No errors

**Command:**
```bash
npm run build
```

**Result:** Build completed successfully with no errors or warnings.

---

## Testing Notes

### Expected Behavior

- BAR charts with titles: Body zone height = container height - title height
- BAR charts with titles and subtitles: Body zone height = container height - title height - subtitle height
- BAR charts without titles: Body zone height = container height (no header to subtract)
- Height recalculates on window resize
- Height recalculates when title/subtitle content changes

### Testing Required

- [ ] Verify BAR charts render with correct body zone height
- [ ] Verify height recalculates on resize
- [ ] Verify height recalculates when title/subtitle changes
- [ ] Verify no layout shift when CSS variable is set
- [ ] Verify backward compatibility (charts without height calculation still work)

---

## Files Modified

1. `app/report/[slug]/ReportChart.tsx`
   - Lines 437-494: Added height calculation logic for BAR charts

2. `components/CellWrapper.module.css`
   - Lines 66-76: Updated `.bodyZone` to use explicit height instead of `flex: 1`

3. `app/report/[slug]/ReportChart.module.css`
   - Lines 370-381: Updated `.bar .chartBody` to use `height: 100%` instead of `flex: 1`

---

## Next Steps

**Phase 2 Status:** ✅ Complete  
**Next Phase:** Phase 3 - PIE Minimum Height Removal (awaiting approval)

**Before Proceeding:**
- Await approval from Chappie
- Perform preview verification if requested
- Document any issues found during testing

---

## Commit

**Commit:** (to be added after commit)  
**Message:** `fix(p1-1.4-phase2): Calculate chart body height explicitly, replace flex: 1`

**Changes:**
- Added height calculation logic for BAR charts (container - title - subtitle)
- Updated `.bodyZone` to use explicit height from CSS custom property
- Updated `.bar .chartBody` to use `height: 100%` instead of `flex: 1`
