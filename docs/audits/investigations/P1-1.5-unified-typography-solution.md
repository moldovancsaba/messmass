# P1 1.5 Unified Typography Solution Proposal

**Date:** 2026-01-10T13:19:42.912Z  
**Status:** Solution Proposal (Awaiting Approval)  
**Investigator:** Tribeca  
**Reference:** `P1-1.5-unified-typography.md` (Investigation)

---

## Solution Goal

Implement block-level typography unification per specification:
- Each Block computes exactly one value: `--block-base-font-size`
- All typography elements within a block use this unified value (with explicit exemptions)
- Eliminate per-row and per-chart independent font size calculations

---

## Block-Level Typography Ownership Model

### Core Principle

**One Block = One Base Font Size**

Each `ReportBlock` component calculates a single `--block-base-font-size` value that applies to all typography elements within that block, except for explicitly exempted elements.

### Typography Hierarchy

```
Block Container
├── --block-base-font-size (calculated once per block)
│
├── Block Title (if present)
│   └── Uses: --block-base-font-size (or derived size)
│
├── Row 1
│   ├── Chart 1 Title → Uses: --block-base-font-size
│   ├── Chart 1 Subtitle → Uses: --block-base-font-size (smaller multiplier)
│   ├── Chart 1 Labels → Uses: --block-base-font-size
│   └── Chart 1 Legends → Uses: --block-base-font-size
│
├── Row 2
│   ├── Chart 2 Title → Uses: --block-base-font-size
│   └── ...
│
└── Text Charts
    └── Uses: --unified-text-font-size (already unified, may align with --block-base-font-size)
```

---

## Explicit Rules by Element Type

### 1. Block Titles

**Rule:** Block-level titles (if present) use `--block-base-font-size` or a derived multiplier.

**Implementation:**
- Block titles are rendered at the block level (not per-row)
- Use `--block-base-font-size` directly or with a multiplier (e.g., `1.2em` for emphasis)
- **File:** `app/report/[slug]/ReportContent.module.css` (`.blockTitle`)

**Status:** Currently uses independent styling. Will be unified.

---

### 2. Chart Titles (CellWrapper Title Zone)

**Rule:** All chart titles within a block use `--block-base-font-size`.

**Current Violation:**
- Chart titles use independent responsive scaling: `clamp(0.9rem, 2.8cqw, 1.25rem)`
- Titles are calculated per-row, not per-block

**Solution:**
- Remove responsive scaling from `.chartTitle` in `ReportChart.module.css`
- Use `--block-base-font-size` from block container
- Remove per-row `titleFontSize` calculation
- Set `--block-base-font-size` on block container, inherit to all charts

**Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx` - Calculate once per block
- **File:** `app/report/[slug]/ReportChart.module.css` - Remove `clamp()` from `.chartTitle`, use `var(--block-base-font-size)`
- **File:** `components/CellWrapper.module.css` - Use `var(--block-base-font-size)` instead of `var(--title-font-size)`

**Status:** Will be unified at block level.

---

### 3. Chart Subtitles (CellWrapper Subtitle Zone)

**Rule:** All chart subtitles within a block use `--block-base-font-size` with a smaller multiplier (e.g., `0.875em` or `0.8em`).

**Current Violation:**
- Subtitles use CSS custom property `--subtitle-font-size` which is set per-row

**Solution:**
- Calculate subtitle size as a multiplier of `--block-base-font-size` (e.g., `calc(var(--block-base-font-size) * 0.875)`)
- Remove per-row `subtitleFontSize` calculation
- Use unified block typography with multiplier

**Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx` - Calculate subtitle multiplier once per block
- **File:** `components/CellWrapper.module.css` - Use `calc(var(--block-base-font-size) * 0.875)` instead of `var(--subtitle-font-size)`

**Status:** Will be unified at block level with multiplier.

---

### 4. KPI Labels (Non-Value)

**Rule:** KPI labels participate in unified typography (not exempt).

**Current Violation:**
- KPI labels use independent responsive scaling: `clamp(0.75rem, 15cqh, 1.5rem)`

**Solution:**
- Remove independent scaling from `.kpi .kpiTitle`
- Use `--block-base-font-size` from block container
- Apply same typography as other chart titles

**Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css` - Remove `clamp()` from `.kpi .kpiTitle`, use `var(--block-base-font-size)`

**Status:** Will be unified at block level.

---

### 5. KPI Values (Explicit Exemption)

**Rule:** KPI values scale independently (explicit exemption per specification).

**Current Implementation:**
- KPI values use independent responsive scaling: `clamp(1.25rem, min(30cqh, 25cqw), 6rem)`

**Solution:**
- **NO CHANGE** - Keep independent scaling
- This is the explicit exemption per specification
- KPI values remain chart-specific and responsive

**Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css` - Keep `.kpiValueRow` independent scaling unchanged

**Status:** ✅ Exempt - No changes required.

---

### 6. Chart Labels (Bar Labels, Pie Labels, etc.)

**Rule:** All chart labels use `--block-base-font-size`.

**Current Violation:**
- Chart labels use independent responsive scaling via `clamp()` with container queries

**Solution:**
- Replace independent scaling with `--block-base-font-size`
- Apply to all label elements: bar labels, pie labels, axis labels

**Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css` - Replace `clamp()` in label styles with `var(--block-base-font-size)`
- **Elements:** `.barLabel`, `.pieLabel`, axis labels, etc.

**Status:** Will be unified at block level.

---

### 7. Chart Legends

**Rule:** All chart legends use `--block-base-font-size`.

**Current Violation:**
- Chart legends use independent responsive scaling: `clamp(var(--mm-font-size-xs, 0.75rem), min(20cqh, 12cqw), var(--mm-font-size-2xl, 1.5rem))`

**Solution:**
- Replace independent scaling with `--block-base-font-size`
- Apply to all legend text elements

**Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css` - Replace `clamp()` in `.pieLegendText` with `var(--block-base-font-size)`

**Status:** Will be unified at block level.

---

### 8. Table Headers and Cells

**Rule:** Table headers and cells use `--block-base-font-size`.

**Current Status:**
- Tables are rendered via markdown parser
- Need to verify current font sizing

**Solution:**
- Ensure table markdown styles inherit from block typography
- Apply `--block-base-font-size` to table headers and cells

**Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css` - Update table markdown styles to use `var(--block-base-font-size)`

**Status:** Will be unified at block level (needs verification during implementation).

---

### 9. Text Charts

**Rule:** Text charts use unified typography (already implemented).

**Current Implementation:**
- Text charts use `--unified-text-font-size` calculated at block level
- This is already compliant with unified typography specification

**Solution:**
- **OPTION A:** Keep `--unified-text-font-size` separate (current implementation)
- **OPTION B:** Align `--unified-text-font-size` with `--block-base-font-size` (use same calculation)

**Recommendation:** **OPTION B** - Use single `--block-base-font-size` for all typography, including text charts. This simplifies the system and ensures true unification.

**Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx` - Calculate `--block-base-font-size` once, use for all typography
- **File:** `app/report/[slug]/ReportChart.module.css` - Text charts use `var(--block-base-font-size)` instead of `var(--unified-text-font-size)`
- **File:** `hooks/useUnifiedTextFontSize.ts` - May be deprecated or aligned with block typography calculation

**Status:** Will be unified with block typography (Option B recommended).

---

## Implementation Strategy

### Phase 1: Block-Level Font Size Calculation

**Goal:** Calculate `--block-base-font-size` once per block.

**Steps:**
1. Move font size calculation from `ResponsiveRow` to `ReportBlock`
2. Calculate unified font size for all cells in all rows of the block
3. Set `--block-base-font-size` CSS custom property on block container
4. Remove per-row `titleFontSize` and `subtitleFontSize` calculations

**Files to Modify:**
- `app/report/[slug]/ReportContent.tsx`
  - Move `calculateSyncedFontSizes` call from `ResponsiveRow` to `ReportBlock`
  - Calculate once per block, considering all rows and all cells
  - Set `--block-base-font-size` on block container
  - Remove `titleFontSize` and `subtitleFontSize` props from `ResponsiveRow`

**Calculation Logic:**
- Collect all titles and subtitles from all cells in all rows
- Use `calculateSyncedFontSizes` with block width (not row width)
- Calculate single `titlePx` and `subtitlePx` for entire block
- Set `--block-base-font-size` = `titlePx` (in rem or px)
- Set `--block-subtitle-font-size` = `subtitlePx` (or use multiplier)

---

### Phase 2: Update CSS to Use Block Typography

**Goal:** Replace independent scaling with unified block typography.

**Steps:**
1. Update chart title styles to use `--block-base-font-size`
2. Update chart subtitle styles to use block typography with multiplier
3. Update KPI label styles to use `--block-base-font-size`
4. Update chart label styles to use `--block-base-font-size`
5. Update chart legend styles to use `--block-base-font-size`
6. Update table styles to use `--block-base-font-size`
7. Update text chart styles to use `--block-base-font-size` (Option B)

**Files to Modify:**
- `app/report/[slug]/ReportChart.module.css`
  - `.chartTitle`: Remove `clamp()`, use `var(--block-base-font-size)`
  - `.kpi .kpiTitle`: Remove `clamp()`, use `var(--block-base-font-size)`
  - `.barLabel`: Remove `clamp()`, use `var(--block-base-font-size)`
  - `.pieLegendText`: Remove `clamp()`, use `var(--block-base-font-size)`
  - Table markdown styles: Use `var(--block-base-font-size)`
  - `.textContent`: Use `var(--block-base-font-size)` instead of `var(--unified-text-font-size)`

- `components/CellWrapper.module.css`
  - `.titleZone`: Use `var(--block-base-font-size)` instead of `var(--title-font-size)`
  - `.subtitleZone`: Use `calc(var(--block-base-font-size) * 0.875)` instead of `var(--subtitle-font-size)`

---

### Phase 3: Remove Per-Row Font Size Logic

**Goal:** Eliminate per-row font size calculations and props.

**Steps:**
1. Remove `titleFontSize` and `subtitleFontSize` state from `ResponsiveRow`
2. Remove `calculateSyncedFontSizes` call from `ResponsiveRow`
3. Remove `titleFontSize` and `subtitleFontSize` props from `ReportChart`
4. Remove `titleFontSize` and `subtitleFontSize` props from `CellWrapper`
5. Clean up unused CSS custom properties

**Files to Modify:**
- `app/report/[slug]/ReportContent.tsx`
  - Remove `titleFontSize` and `subtitleFontSize` state from `ResponsiveRow`
  - Remove `calculateSyncedFontSizes` call from `ResponsiveRow`
  - Remove props from `ReportChart` component calls

- `app/report/[slug]/ReportChart.tsx`
  - Remove `titleFontSize` and `subtitleFontSize` props from component signatures
  - Remove prop passing to `CellWrapper`

- `components/CellWrapper.tsx`
  - Remove `titleFontSize` and `subtitleFontSize` props
  - Remove CSS custom property setting for these props

---

### Phase 4: Align Text Chart Typography (Optional - Option B)

**Goal:** Use single `--block-base-font-size` for all typography, including text charts.

**Steps:**
1. Deprecate or align `useUnifiedTextFontSize` hook with block typography
2. Update text chart styles to use `--block-base-font-size`
3. Remove `--unified-text-font-size` if no longer needed

**Files to Modify:**
- `app/report/[slug]/ReportContent.tsx`
  - Remove `useUnifiedTextFontSize` hook call (or align with block typography)
  - Remove `--unified-text-font-size` CSS custom property setting

- `app/report/[slug]/ReportChart.module.css`
  - `.textContent`: Use `var(--block-base-font-size)` instead of `var(--unified-text-font-size)`

- `hooks/useUnifiedTextFontSize.ts`
  - May be deprecated if Option B is chosen

---

## Typography Calculation Algorithm

### Block-Level Font Size Calculation

```typescript
// Pseudocode for block-level calculation
function calculateBlockTypography(block: ReportBlock, chartResults: Map<string, ChartResult>, blockWidthPx: number): BlockTypography {
  // Collect all titles and subtitles from all rows in block
  const allTitles: string[] = [];
  const allSubtitles: string[] = [];
  
  block.rows.forEach(row => {
    row.charts.forEach(chart => {
      const result = chartResults.get(chart.chartId);
      if (result?.title) allTitles.push(result.title);
      if (result?.subtitle) allSubtitles.push(result.subtitle);
    });
  });
  
  // Calculate unified font sizes for entire block
  const syncedFonts = calculateSyncedFontSizes(
    allTitles.map(title => ({ title, subtitle: '' })),
    blockWidthPx,
    { maxTitleLines: 2, maxSubtitleLines: 2 }
  );
  
  return {
    baseFontSize: syncedFonts.titlePx, // in px
    subtitleFontSize: syncedFonts.subtitlePx, // in px, or use multiplier
  };
}
```

### CSS Custom Properties

```css
/* Block container */
.block {
  --block-base-font-size: 18px; /* Calculated once per block */
  --block-subtitle-font-size: calc(var(--block-base-font-size) * 0.875); /* Or calculated separately */
}

/* All typography elements inherit */
.chartTitle {
  font-size: var(--block-base-font-size);
}

.subtitleZone {
  font-size: var(--block-subtitle-font-size);
}

.kpiLabel {
  font-size: var(--block-base-font-size);
}

.barLabel {
  font-size: var(--block-base-font-size);
}

.pieLegendText {
  font-size: var(--block-base-font-size);
}
```

---

## Exemptions and Chart-Specific Typography

### Explicit Exemptions

1. **KPI Values:**
   - **Status:** Exempt (per specification)
   - **Implementation:** Keep independent responsive scaling: `clamp(1.25rem, min(30cqh, 25cqw), 6rem)`
   - **File:** `app/report/[slug]/ReportChart.module.css` - `.kpiValueRow`

### Chart-Specific Typography (If Any)

**None.** All typography elements (except KPI values) participate in unified block typography.

---

## Acceptance Criteria

### Block-Level Unification
- ✅ `--block-base-font-size` is calculated once per block
- ✅ All chart titles in a block use the same font size
- ✅ All chart subtitles in a block use the same font size (with multiplier)
- ✅ All chart labels in a block use the same font size
- ✅ All chart legends in a block use the same font size
- ✅ All table headers/cells in a block use the same font size
- ✅ All text charts in a block use the same font size (Option B)

### Exemptions Preserved
- ✅ KPI values scale independently (explicit exemption)
- ✅ No other exemptions introduced

### Implementation Quality
- ✅ No per-row font size calculations
- ✅ No per-chart independent responsive scaling (except KPI values)
- ✅ Single source of truth: `--block-base-font-size` on block container
- ✅ All typography elements inherit from block typography

---

## Risk Assessment

### Low Risk
- Text charts already use unified typography (can be aligned)
- KPI values are explicitly exempt (no changes required)

### Medium Risk
- Moving calculation from row-level to block-level may affect layout
- Need to ensure block width is correctly measured
- Need to verify all chart types work with unified typography

### Mitigation
- Test with various block configurations (single row, multiple rows, mixed chart types)
- Verify responsive behavior (block width changes)
- Ensure typography scales appropriately for all content lengths

---

## Non-Goals

### What This Solution Will NOT Address
1. **Typography scaling based on container height:** This is handled by container queries and is separate from unification
2. **Minimum/maximum font size limits:** These remain in place via `clamp()` or design tokens
3. **Responsive breakpoints:** Typography still responds to container width, but unified within block
4. **Content length adaptation:** Block height may still increase if content doesn't fit (Layout Grammar)

---

## Implementation Order

1. **Phase 1:** Block-level font size calculation (move from row to block)
2. **Phase 2:** Update CSS to use block typography (replace independent scaling)
3. **Phase 3:** Remove per-row font size logic (cleanup)
4. **Phase 4:** Align text chart typography (Option B - optional)

**Estimated Effort:** 3-4 hours (matches audit plan estimate)

---

## Next Steps

**Status:** Solution proposal complete. Awaiting approval.

**Deliverable:** This solution document with explicit rules, implementation strategy, and acceptance criteria.

**Awaiting:** Approval to proceed with implementation (Phase 1-4).

---

## References

- Investigation: `docs/audits/investigations/P1-1.5-unified-typography.md`
- Specification: `UNIFIED_DESIGN_SYSTEM_MASTER_PLAN.md` Section 4
- Current Implementation: `lib/fontSyncCalculator.ts`, `hooks/useUnifiedTextFontSize.ts`
