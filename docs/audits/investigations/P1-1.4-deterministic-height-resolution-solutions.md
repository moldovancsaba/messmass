# P1 1.4 – Deterministic Height Resolution Solution Proposal

**Date:** 2026-01-10T12:16:01.300Z  
**Status:** Solution Design (No Implementation)  
**Investigator:** Tribeca  
**Reference:** `P1-1.4-deterministic-height-resolution.md`

---

## Executive Summary

This document proposes a single, deterministic strategy for height resolution across report layouts. The strategy eliminates implicit height behavior, establishes clear ownership precedence, and ensures all 11 FRAGILE components become deterministic or explicitly delegated.

**Core Principle:** Height must be explicit, traceable, and predictable. No implicit fallbacks, no content-driven height, no unbounded flex growth.

---

## Single Recommended Strategy: Explicit Height Cascade

### Strategy Overview

**Height flows from a single source of truth (block/row calculation) down through an explicit cascade, with no implicit fallbacks.**

```
Block/Row Calculation (solveBlockHeightWithImages)
    ↓
CSS Custom Property (--block-height, --row-height)
    ↓
Chart Container (explicit height from CSS variable)
    ↓
Chart Body (explicit height calculation from container)
    ↓
Chart Content (explicit height from parent, no flex growth)
```

### Key Principles

1. **Single Source of Truth:** Block/row height is calculated deterministically via `solveBlockHeightWithImages()`
2. **Explicit Cascade:** Height propagates via CSS custom properties, never via `100%` or `auto` fallbacks
3. **No Implicit Behavior:** Every height value must be traceable to a calculation or token
4. **Bounded Flex Growth:** Flex ratios are allowed only within explicitly bounded containers
5. **Minimum Height Constraints:** Minimum heights are removed or converted to bounded flex growth

---

## Height Ownership Precedence Rules

### Rule 1: Block/Row Owns Height (Highest Priority)

**Owner:** `ResponsiveRow` component via `solveBlockHeightWithImages()`

**Enforcement:**
- Height calculated deterministically from cell distribution and image aspect ratios
- Set as CSS custom property `--block-height` and `--row-height` on row container
- Recalculated on resize via ResizeObserver

**Precedence:** All other components inherit from this height. No component may override block/row height.

### Rule 2: Chart Container Inherits Explicitly (Second Priority)

**Owner:** Parent row via CSS custom property

**Enforcement:**
- Chart container MUST use `height: var(--block-height)` (no fallback)
- If CSS variable is not available, chart container MUST use a design token default
- No `100%` or `auto` fallbacks allowed

**Precedence:** Chart container height is explicit, never implicit.

### Rule 3: Chart Body Calculates from Container (Third Priority)

**Owner:** Parent chart container

**Enforcement:**
- Chart body height calculated as: `container height - header height - padding`
- Set as explicit pixel value or CSS custom property
- No `flex: 1` without explicit height constraint

**Precedence:** Chart body height is calculated, not flex-grown.

### Rule 4: Chart Content Inherits from Body (Fourth Priority)

**Owner:** Parent chart body

**Enforcement:**
- Chart content uses `height: 100%` only if parent has explicit height
- If parent height is not explicit, content uses design token default
- No content-driven height (no `auto`, no `min-content`)

**Precedence:** Chart content height is inherited, never content-driven.

---

## Token vs Calculation vs Content-Driven Boundaries

### Design Token Height (Static)

**When to Use:**
- Default fallback values when calculation is not available
- Minimum/maximum bounds for calculations
- Fixed component heights (e.g., header, footer)

**Examples:**
- `--mm-block-height-default: 360px`
- `--mm-block-height-min: 150px`
- `--mm-block-height-max: 800px`

**Boundary Rule:** Tokens are fallbacks, not primary height sources. Primary height must come from calculation.

### Calculated Height (Dynamic)

**When to Use:**
- Block/row height from `solveBlockHeightWithImages()`
- Chart body height from container minus header/padding
- Responsive height adjustments based on viewport

**Examples:**
- `H = blockWidth / totalEffectiveUnits`
- `chartBodyHeight = containerHeight - headerHeight - padding`

**Boundary Rule:** Calculations must be deterministic and traceable. No calculations that depend on content size.

### Content-Driven Height (Forbidden)

**When NOT to Use:**
- Never use `height: auto` on chart containers or bodies
- Never use `min-content` or `max-content` on chart components
- Never rely on flex growth without explicit height constraints

**Boundary Rule:** Content-driven height is forbidden in report layouts. All height must be explicit.

---

## Handling the 11 FRAGILE Components

### Category 1: CSS Variable Fallback Issues (6 components)

**Components:**
1. Chart Container (`.chart`)
2. PIE Chart Container
3. Bar Chart
4. Text Chart
5. Table Chart
6. Image Chart

**Current Issue:** `height: var(--block-height, var(--row-height, 100%))` falls back to `100%` if CSS variables not set.

**Solution:**
- Remove `100%` fallback
- Use design token default: `height: var(--block-height, var(--row-height, var(--mm-block-height-default)))`
- Ensure CSS variables are always set before chart render (SSR/initial render handling)

**Implementation:**
- Update CSS to use token fallback instead of `100%`
- Add SSR/initial render check to ensure CSS variables are set
- Add runtime validation to warn if CSS variables are missing

### Category 2: Flex Growth Without Constraints (3 components)

**Components:**
1. Chart Body (`.chartBody`)
2. Bar Chart Body
3. Text Chart Body

**Current Issue:** `flex: 1` with `min-height: 0` relies on parent height being explicit.

**Solution:**
- Calculate chart body height explicitly: `containerHeight - headerHeight - padding`
- Set as CSS custom property: `--chart-body-height`
- Use explicit height: `height: var(--chart-body-height)`
- Remove `flex: 1` or constrain it with explicit height

**Implementation:**
- Calculate chart body height in component logic
- Set CSS custom property on chart container
- Update CSS to use explicit height instead of flex growth

### Category 3: Minimum Height Override Issues (2 components)

**Components:**
1. PIE Chart Container (Chart.js) - `min-height: 100px`
2. PIE Legend - `min-height: 60px`

**Current Issue:** Minimum height may override flex ratios in constrained spaces.

**Solution:**
- Remove minimum height constraints
- Use bounded flex growth: `flex: 0 0 40%` with `max-height: 40%` for pie container
- Use bounded flex growth: `flex: 1 1 30%` with `max-height: 50%` for legend (allows growth but bounded)
- Ensure parent height is explicit so percentages work correctly

**Implementation:**
- Remove `min-height` from PIE chart container and legend
- Add `max-height` constraints to prevent unbounded growth
- Ensure parent `.pieGrid` has explicit height

### Category 4: Row Height Fallback (1 component)

**Component:**
1. Row (`.row`) - `height: var(--row-height, auto)`

**Current Issue:** Falls back to `auto` if CSS variable not set, causing content-driven height.

**Solution:**
- Remove `auto` fallback
- Use design token default: `height: var(--row-height, var(--mm-block-height-default))`
- Ensure CSS variable is always set before row render

**Implementation:**
- Update CSS to use token fallback instead of `auto`
- Add runtime validation to ensure CSS variable is set
- Add SSR/initial render check

### Category 5: Text Content Height (1 component)

**Component:**
1. Text Content (`.textContent`) - `height: 100%` with implicit parent

**Current Issue:** Relies on parent height being explicit, which may not be guaranteed.

**Solution:**
- Ensure parent text chart body has explicit height (handled in Category 2)
- Add fallback: `height: var(--text-content-height, var(--mm-block-height-default))`
- Remove `min-height: 0` to prevent shrinking

**Implementation:**
- Calculate text content height from parent body height
- Set as CSS custom property
- Update CSS to use explicit height with token fallback

---

## Explicit Non-Goals

### What P1 1.4 Will NOT Solve

1. **Typography Scaling:** Font size scaling based on container height is out of scope. This is handled by P1 2.5.1 and unified typography systems.

2. **Spacing and Padding:** Spacing adjustments based on height are out of scope. This is handled by design tokens and layout grammar.

3. **Layout Grammar Compliance:** P1 1.4 does not address scrolling, truncation, or clipping. These are handled by P0 1.1-1.3.

4. **Responsive Breakpoint Behavior:** Viewport-based height adjustments are out of scope. P1 1.4 focuses on deterministic height within a given viewport size.

5. **Content Length Adaptation:** P1 1.4 does not solve how height adapts when content length changes. Height remains fixed based on block calculation; content must fit through other means (wrapping, reflow, etc.).

6. **Chart Type Switching:** P1 1.4 does not address height changes when chart type changes. Each chart type must work within the deterministic block height.

7. **CellWrapper Component:** CellWrapper is not used in report layouts and is out of scope. If it is used in the future, it will need its own height strategy.

---

## Implementation Plan (Ordered, No Code)

### Phase 1: CSS Variable Fallback Elimination

**Goal:** Remove all `100%` and `auto` fallbacks from height declarations.

**Steps:**
1. Update chart container CSS to use design token fallback instead of `100%`
2. Update row CSS to use design token fallback instead of `auto`
3. Add runtime validation to warn if CSS variables are missing
4. Test SSR and initial render scenarios

**Files to Modify:**
- `app/report/[slug]/ReportChart.module.css` (chart containers)
- `app/report/[slug]/ReportContent.module.css` (row)

**Acceptance Criteria:**
- No `100%` or `auto` fallbacks in height declarations
- All fallbacks use design tokens
- Runtime validation warns if CSS variables are missing

### Phase 2: Chart Body Height Calculation

**Goal:** Calculate chart body height explicitly instead of using flex growth.

**Steps:**
1. Calculate chart body height in `ReportChart` component: `containerHeight - headerHeight - padding`
2. Set as CSS custom property `--chart-body-height` on chart container
3. Update chart body CSS to use explicit height instead of `flex: 1`
4. Apply to all chart types (PIE, BAR, TEXT, TABLE, IMAGE, KPI)

**Files to Modify:**
- `app/report/[slug]/ReportChart.tsx` (height calculation logic)
- `app/report/[slug]/ReportChart.module.css` (chart body styles)

**Acceptance Criteria:**
- Chart body height is calculated explicitly
- No `flex: 1` without explicit height constraint
- All chart types use explicit height

### Phase 3: PIE Chart Minimum Height Removal

**Goal:** Remove minimum height constraints that override flex ratios.

**Steps:**
1. Remove `min-height: 100px` from PIE chart container
2. Remove `min-height: 60px` from PIE legend
3. Add `max-height: 40%` to PIE chart container to prevent unbounded growth
4. Add `max-height: 50%` to PIE legend to allow growth but bound it
5. Ensure parent `.pieGrid` has explicit height

**Files to Modify:**
- `app/report/[slug]/ReportChart.module.css` (PIE chart container and legend)

**Acceptance Criteria:**
- No minimum height constraints on PIE components
- Maximum height constraints prevent unbounded growth
- Flex ratios work correctly in all container sizes

### Phase 4: Text Content Height Explicit

**Goal:** Ensure text content height is explicit, not implicit.

**Steps:**
1. Calculate text content height from parent body height
2. Set as CSS custom property `--text-content-height`
3. Update text content CSS to use explicit height with token fallback
4. Remove `min-height: 0` to prevent shrinking

**Files to Modify:**
- `app/report/[slug]/ReportChart.tsx` (text content height calculation)
- `app/report/[slug]/ReportChart.module.css` (text content styles)

**Acceptance Criteria:**
- Text content height is explicit
- No `min-height: 0` that allows shrinking
- Token fallback provides safe default

### Phase 5: Validation and Testing

**Goal:** Ensure all height values are deterministic and traceable.

**Steps:**
1. Add runtime validation to check all CSS variables are set
2. Add console warnings if height values are implicit
3. Test all breakage scenarios from investigation:
   - CSS variable not set (SSR, initial render)
   - Content length changes
   - Responsive breakpoint shift
   - Small container constraints
   - Chart type changes
4. Verify no layout shifts or content clipping

**Files to Modify:**
- `app/report/[slug]/ReportContent.tsx` (validation logic)
- `app/report/[slug]/ReportChart.tsx` (validation logic)

**Acceptance Criteria:**
- All height values are explicit and traceable
- No implicit height behavior
- All breakage scenarios handled
- No layout shifts or content clipping

---

## Success Criteria

### Deterministic Height Resolution is Achieved When:

1. ✅ All 11 FRAGILE components become SAFE (deterministic) or explicitly delegated
2. ✅ No `100%` or `auto` fallbacks in height declarations
3. ✅ All height values traceable to calculation or token
4. ✅ No content-driven height in report layouts
5. ✅ No unbounded flex growth
6. ✅ No minimum height constraints that override flex ratios
7. ✅ Runtime validation warns if height values are implicit
8. ✅ All breakage scenarios from investigation are handled

### Verification Method:

- Visual inspection: All charts render at consistent heights
- Console inspection: No warnings about missing CSS variables
- Layout shift measurement: No layout shifts when content changes
- Responsive testing: Height remains deterministic across breakpoints

---

## Risk Assessment

### Low Risk Changes:
- CSS variable fallback updates (Phase 1)
- Minimum height removal (Phase 3)

### Medium Risk Changes:
- Chart body height calculation (Phase 2)
- Text content height explicit (Phase 4)

### High Risk Areas:
- SSR/initial render handling (must ensure CSS variables are set)
- Responsive breakpoint behavior (must ensure height recalculates correctly)

### Mitigation:
- Incremental implementation (one phase at a time)
- Preview verification after each phase
- Rollback plan for each phase
- Extensive testing of breakage scenarios

---

## Dependencies

### Required Before Implementation:
- ✅ P0 1.1-1.3 complete (Layout Grammar compliance)
- ✅ P0 3.4 Phase 1 complete (Design tokens available)
- ✅ P1 1.4 investigation complete (this document)

### Blocks Future Work:
- None identified. P1 1.4 is independent of other workstreams.

---

## Solution Proposal Complete

**Status:** ✅ Solution design complete, awaiting approval  
**Next Steps:** Await explicit approval before proceeding to implementation  
**Implementation Estimate:** 4-6 hours (aligned with original effort estimate)

---

## Files to Be Modified (Reference Only, No Code Yet)

- `app/report/[slug]/ReportChart.module.css` - Chart container and body height styles
- `app/report/[slug]/ReportChart.tsx` - Height calculation logic
- `app/report/[slug]/ReportContent.module.css` - Row height styles
- `app/report/[slug]/ReportContent.tsx` - Height validation logic
- `app/styles/theme.css` - Design token defaults (if new tokens needed)

---

## References

- Investigation Document: `docs/audits/investigations/P1-1.4-deterministic-height-resolution.md`
- Layout Grammar Spec: `docs/design/LAYOUT_GRAMMAR.md`
- Block Height Calculator: `lib/blockHeightCalculator.ts`
- Design Tokens: `app/styles/theme.css`
