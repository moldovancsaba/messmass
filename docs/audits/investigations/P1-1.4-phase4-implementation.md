# P1 1.4 Phase 4 – Text Content Height Explicit Implementation

**Date:** 2026-01-10T12:48:18.300Z  
**Status:** Phase 4 Complete  
**Investigator:** Tribeca  
**Reference:** `P1-1.4-deterministic-height-resolution-solutions.md`

---

## Phase 4 Goal

Ensure text content height is explicit, not implicit. Replace content-driven or implicit height behavior with explicit inheritance from parent zones.

---

## Changes Implemented

### 1. Text Chart Height Calculation

**File:** `app/report/[slug]/ReportChart.tsx:566-654`

**Added:**
- Refs for text chart container (`textChartRef`) and text content wrapper (`textContentWrapperRef`)
- `useEffect` hook that:
  - Measures text chart container height (`offsetHeight`)
  - Measures title wrapper height (if exists)
  - Calculates text content height: `containerHeight - titleHeight`
  - Sets CSS custom property `--text-content-height` on chart container
  - Uses `ResizeObserver` to recalculate on resize

**Rationale:** Explicit height calculation replaces implicit flex growth, ensuring deterministic behavior for text content.

### 2. Table Chart Height Calculation

**File:** `app/report/[slug]/ReportChart.tsx:657-730`

**Added:**
- Ref for table content (`tableContentRef`)
- `useEffect` hook that:
  - Finds parent CellWrapper container
  - Gets `--chart-body-height` from CellWrapper (set in Phase 2)
  - Sets CSS custom property `--text-content-height` on table content element
  - Uses `ResizeObserver` to recalculate on resize

**Rationale:** Table content is inside CellWrapper body zone, which already has `--chart-body-height` from Phase 2. Reuse that value for table content height.

### 3. Text Content Wrapper CSS Update

**File:** `app/report/[slug]/ReportChart.module.css:524-542`

**Before:**
```css
.textContentWrapper {
  flex: 1 !important; /* CRITICAL: Fill all remaining space after title */
  min-height: 0 !important; /* CRITICAL: Allow flex shrinking */
  ...
}
```

**After:**
```css
.textContentWrapper {
  height: var(--text-content-height, var(--mm-block-height-default)); /* WHAT: P1 1.4 Phase 4 - explicit height from calculation, fallback to design token */
  ...
}
```

**Rationale:** Replaced `flex: 1` and `min-height: 0` with explicit height from CSS custom property. Fallback to design token provides safe default.

### 4. Text Content CSS Update

**File:** `app/report/[slug]/ReportChart.module.css:544-575`

**Before:**
```css
.textContent {
  height: 100% !important;
  min-height: 0 !important; /* CRITICAL: Allow flex shrinking */
  ...
}
```

**After:**
```css
.textContent {
  height: 100% !important; /* CRITICAL: Fill parent height completely (parent has explicit height from Phase 4) */
  ...
}
```

**Rationale:** Removed `min-height: 0` to prevent shrinking. Parent `.textContentWrapper` now has explicit height, so child can use `height: 100%` safely.

### 5. Table Content CSS Update

**File:** `app/report/[slug]/ReportChart.module.css:839-847`

**Before:**
```css
.tableContent {
  width: 100%;
  height: 100%;
  ...
}
```

**After:**
```css
.tableContent {
  width: 100%;
  height: var(--text-content-height, var(--mm-block-height-default)); /* WHAT: P1 1.4 Phase 4 - explicit height from calculation (uses --chart-body-height from Phase 2), fallback to design token */
  ...
}
```

**Rationale:** Replaced `height: 100%` with explicit height from CSS custom property. Uses `--chart-body-height` from Phase 2 (table content is inside CellWrapper body zone).

### 6. Table Markdown CSS Update

**File:** `app/report/[slug]/ReportChart.module.css:849-856`

**Before:**
```css
.tableMarkdown {
  width: 100%;
  height: 100%;
  ...
}
```

**After:**
```css
.tableMarkdown {
  width: 100%;
  height: 100%; /* WHAT: Fill parent tableContent height (explicit height from Phase 4) */
  ...
}
```

**Rationale:** Updated comment to clarify that parent `.tableContent` now has explicit height from Phase 4.

---

## Implementation Details

### Height Calculation Strategy

1. **Text Chart:**
   - Container: `.text` (height from `--block-height` from row)
   - Title: `.textTitleWrapper` (measured height)
   - Content: `.textContentWrapper` (calculated: container - title)
   - CSS custom property: `--text-content-height` set on `.text` container

2. **Table Chart:**
   - Container: CellWrapper (has `--chart-body-height` from Phase 2)
   - Content: `.tableContent` (uses `--chart-body-height` as `--text-content-height`)
   - CSS custom property: `--text-content-height` set on `.tableContent` element

### ResizeObserver Integration

- Observes chart containers for size changes
- Recalculates content height on resize
- Cleans up observer on component unmount

### Design Token Fallback

- Both text and table content use `var(--text-content-height, var(--mm-block-height-default))`
- Provides safe default when CSS variable is not set
- Maintains backward compatibility

---

## Acceptance Criteria Verification

### ✅ Text content height is explicit
- Text chart: Calculates content height as `containerHeight - titleHeight`
- Table chart: Uses `--chart-body-height` from Phase 2
- Both set CSS custom property `--text-content-height`

### ✅ No `min-height: 0` that allows shrinking
- Removed `min-height: 0` from `.textContentWrapper`
- Removed `min-height: 0` from `.textContent`
- Parent containers now have explicit height, so shrinking is not needed

### ✅ Token fallback provides safe default
- Both text and table content use `var(--mm-block-height-default)` as fallback
- Ensures content is visible even if CSS variable is not set

---

## Local Gate Results

**Build:** ✅ Pass  
**Linting:** ✅ No errors  
**TypeScript:** ✅ No errors

**Command:**
```bash
npm run build
```

**Result:** Build completed successfully with no errors or warnings.

---

## Testing Notes

### Expected Behavior

- **Text charts with titles:** Content height = container height - title height
- **Text charts without titles:** Content height = container height
- **Table charts:** Content height = body zone height (from Phase 2)
- Height recalculates on window resize
- Height recalculates when title content changes

### Testing Required

- [ ] Verify text charts render with correct content height
- [ ] Verify table charts render with correct content height
- [ ] Verify height recalculates on resize
- [ ] Verify height recalculates when title changes
- [ ] Verify no layout shift when CSS variable is set
- [ ] Verify fallback behavior (design token) works when CSS variable is not set

---

## Files Modified

1. `app/report/[slug]/ReportChart.tsx`
   - Lines 566-654: Added height calculation logic for text charts
   - Lines 657-730: Added height calculation logic for table charts

2. `app/report/[slug]/ReportChart.module.css`
   - Lines 524-542: Updated `.textContentWrapper` to use explicit height
   - Lines 544-575: Removed `min-height: 0` from `.textContent`
   - Lines 839-847: Updated `.tableContent` to use explicit height
   - Lines 849-856: Updated `.tableMarkdown` comment

---

## Next Steps

**Phase 4 Status:** ✅ Complete  
**Next Phase:** Phase 5 - Validation and Testing (awaiting approval)

**Before Proceeding:**
- Await approval from Chappie
- Perform preview verification if requested
- Document any issues found during testing

---

## Commit

**Commit:** `2c312f57f`  
**Message:** `fix(p1-1.4-phase4): Make text content height explicit, remove min-height: 0`

**Changes:**
- Added height calculation for text charts (container - title)
- Added height calculation for table charts (uses --chart-body-height from Phase 2)
- Updated `.textContentWrapper` to use explicit height instead of flex: 1
- Removed `min-height: 0` from `.textContent` and `.textContentWrapper`
- Updated `.tableContent` to use explicit height
