# P1 1.5 BAR Chart Label Overlap Fix - Investigation

**Date:** 2026-01-11T15:04:35.300Z  
**Status:** Architectural Remediation Required  
**Investigator:** Tribeca  
**Reference:** Layout Grammar violation - content collision/clipping (architectural grouping failure)

---

## Problem

BAR chart labels that wrap to 2 lines still overlap neighboring labels. Sultan tested the corrected fix on Preview and it is worse: labels still collide and bars now visually collapse into each other.

---

## Root Cause Analysis (Architectural)

**Why previous fixes failed:**

This is **not a spacing bug, it is a grouping failure**. The BAR chart lacks a strict row ownership contract. Multi-line labels must increase row height and push subsequent rows down. Any vertical distribution or compression logic breaks Layout Grammar and causes collisions.

**Architectural problem:**
- Using **flexbox with distribution logic** (`justify-content: flex-start`, `space-evenly`, etc.) does not guarantee strict row ownership
- When labels wrap, the flex container tries to distribute or compress space, causing collisions
- Bars collapse because there's no minimum height constraint and the container compresses rows

**The fundamental issue:**
- `.barElements` uses `display: flex` with `flex: 1` and `justify-content` properties
- Flexbox distribution logic interferes with content-driven row heights
- No strict row ownership contract - rows can be compressed or distributed

**Container constraints:**
- `.barElements` is inside `.chartBody` which has explicit height from P1 1.4 Phase 2 (`--chart-body-height`)
- The flex container tries to fill all available space and distribute bars, but doesn't respect content-driven row heights

---

## Current Implementation

```css
.barElements {
  display: flex;
  flex-direction: column;
  gap: 0; /* ❌ No gap between rows */
  flex: 1; /* Fills all space */
  justify-content: space-evenly; /* ❌ Distributes evenly, doesn't account for variable heights */
  width: 100%;
  max-width: none !important;
  min-height: 0;
}

.barRow {
  display: grid;
  grid-template-columns: minmax(0, 25%) minmax(0, 1fr) auto;
  column-gap: var(--mm-space-3);
  row-gap: var(--mm-space-1);
  align-items: start; /* ✅ Fixed */
  padding-block: var(--mm-space-1); /* ✅ Fixed */
  /* flex: 1 removed ✅ */
}
```

---

## Corrected Fix Required

**Changes to `.barElements`:**
1. Change `justify-content: space-evenly` to `flex-start` - Allow rows to stack naturally
2. Change `gap: 0` to `gap: var(--mm-space-1)` or similar - Add spacing between rows
3. Keep `flex: 1` but remove `justify-content: space-evenly` - Allow natural stacking

**Changes to `.barRow`:**
- Already fixed (removed `flex: 1`, changed `align-items: start`)
- May need to adjust `padding-block` if gap is added to parent

**Guarantees:**
- ✅ Rows grow with content height (no `flex: 1` on rows, no `space-evenly`)
- ✅ No overlap between adjacent rows (proper gap, natural stacking)
- ✅ Bar track and value alignment stays correct (already fixed with `align-self: center`)
- ✅ No clipping, no scroll, no truncation (already fixed with wrapping properties)

---

## Architectural Remediation Required

**Solution: Table/Grid Model with Strict Row Ownership**

The BAR chart must use CSS Grid with `grid-auto-rows: max-content` to ensure each row owns its height based on content, and rows stack deterministically without any distribution logic.

**Required structural changes:**

1. **`.barElements` - Grid container (not flex):**
   - `display: grid` (not flex)
   - `grid-auto-rows: max-content` - Each row owns its height based on content
   - `row-gap: var(--mm-space-1)` - Spacing between rows
   - `align-content: start` - Stack rows from top
   - Remove all vertical distribution logic (no `justify-content`, no `space-evenly`, no `space-around`)
   - Remove `flex: 1` - Grid fills available space naturally

2. **`.barRow` - 3-column grid:**
   - `display: grid` (already grid)
   - `grid-template-columns: minmax(0, 25%) minmax(0, 1fr) max-content` - Label 25% | Track fills | Value max-content
   - `column-gap: var(--mm-space-2)` - Spacing between columns
   - `align-items: start` - Align labels at top

3. **Wrapping rules (non-negotiable):**
   - `.barLabel`: unlimited wrapping
     - `white-space: normal`
     - `overflow-wrap: anywhere`
     - `word-break: break-word`
     - No line-clamp
   - `.barValue`: single-line only
     - `white-space: nowrap`

4. **Bar stability:**
   - `.barTrack` must have a minimum height so bars cannot collapse under vertical constraint
   - Bars align with the first line of the label, never overlapping adjacent rows

**Guarantees:**
- ✅ Rows grow with content height (grid-auto-rows: max-content)
- ✅ No overlap between adjacent rows (strict row ownership, no distribution logic)
- ✅ Bar track and value alignment correct (grid columns, align-items: start)
- ✅ Bars maintain readable thickness (minimum height on .barTrack)
- ✅ No clipping, no scroll, no truncation (wrapping properties in place)

---

## Architectural Fix Applied

**Changes to `.barElements`:**
1. ✅ Changed `display: flex` to `display: grid` - Grid model for strict row ownership
2. ✅ Added `grid-auto-rows: max-content` - Each row owns its height based on content
3. ✅ Changed `gap: var(--mm-space-1)` to `row-gap: var(--mm-space-1)` - Grid row gap
4. ✅ Added `align-content: start` - Stack rows from top
5. ✅ Removed `flex: 1` - Grid fills available space naturally
6. ✅ Removed `justify-content: flex-start` - No distribution logic
7. ✅ Removed `align-items: stretch` - Not needed in grid

**Changes to `.barRow`:**
- ✅ Changed `grid-template-columns: minmax(0, 25%) minmax(0, 1fr) auto` to `minmax(0, 25%) minmax(0, 1fr) max-content` - Value column uses max-content
- ✅ Changed `column-gap: var(--mm-space-3)` to `var(--mm-space-2)` - Consistent spacing
- ✅ Already has `align-items: start` - Align labels at top

**Changes to `.barTrack`:**
- ✅ Added `min-height: clamp(1.2rem, 22cqh, 1.44rem)` - Prevent bar collapse
- ✅ Keep `height: clamp(1.2rem, 22cqh, 1.44rem)` - Maintain bar thickness

**Wrapping rules verified:**
- ✅ `.barLabel`: `white-space: normal`, `overflow-wrap: anywhere`, `word-break: break-word`, no line-clamp
- ✅ `.barValue`: `white-space: nowrap`

**Local Gate Results:**
- Build: ✅ Pass
- Linting: ✅ No errors
- TypeScript: ✅ No errors

**Files Modified:**
- `app/report/[slug]/ReportChart.module.css` (`.barElements`, `.barRow`, `.barTrack`)

**Commits:**
- `90aaab206` - fix(p1-1.5): Architectural remediation - BAR chart grid model with strict row ownership
- `ad41d4b8c` - docs(p1-1.5): Update audit plan with architectural BAR chart remediation

**Next Steps:**
1. Push to preview branch (Sultan required)
2. Preview verification on canonical preview URL
3. Test with exact failing slug and narrow viewport where labels wrap to 2+ lines
4. Document evidence (URL, page, viewport, expected vs observed, screenshots if needed)
