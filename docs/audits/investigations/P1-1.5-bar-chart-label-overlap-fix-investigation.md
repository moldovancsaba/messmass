# P1 1.5 BAR Chart Label Overlap Fix - Investigation

**Date:** 2026-01-11T08:22:33.300Z  
**Status:** Investigation Complete  
**Investigator:** Tribeca  
**Reference:** Layout Grammar violation - content collision/clipping (still failing after initial fix)

---

## Problem

BAR chart labels that wrap to 2 lines still overlap neighboring labels after the initial fix. Sultan tested on Preview and confirmed the issue persists.

---

## Root Cause Analysis

**Why the current fix didn't work:**

The issue is in the **`.barElements` container**, not just `.barRow`:

1. **`.barElements` has `justify-content: space-evenly`** (line 395)
   - This distributes bars evenly across the full height
   - When a label wraps to 2 lines, the row height increases, but `space-evenly` still tries to distribute evenly
   - This causes rows to overlap because the container doesn't account for variable row heights

2. **`.barElements` has `gap: 0`** (line 393)
   - No gap between rows, so when rows grow, they can overlap

3. **`.barElements` has `flex: 1`** (line 394)
   - Fills all remaining vertical space, but with `space-evenly`, this forces equal distribution

**The selector causing collision:**
- `.barElements` with `justify-content: space-evenly` and `gap: 0`

**Container constraints:**
- `.barElements` is inside `.chartBody` which has explicit height from P1 1.4 Phase 2 (`--chart-body-height`)
- The container tries to fill all available space and distribute bars evenly, but doesn't account for variable row heights

---

## Current Implementation

```css
.barElements {
  display: flex;
  flex-direction: column;
  gap: 0; /* ❌ No gap between rows */
  flex: 1; /* Fills all space */
  justify-content: space-evenly; /* ❌ Distributes evenly, doesn't account for variable heights */
  width: 100%;
  max-width: none !important;
  min-height: 0;
}

.barRow {
  display: grid;
  grid-template-columns: minmax(0, 25%) minmax(0, 1fr) auto;
  column-gap: var(--mm-space-3);
  row-gap: var(--mm-space-1);
  align-items: start; /* ✅ Fixed */
  padding-block: var(--mm-space-1); /* ✅ Fixed */
  /* flex: 1 removed ✅ */
}
```

---

## Corrected Fix Required

**Changes to `.barElements`:**
1. Change `justify-content: space-evenly` to `flex-start` - Allow rows to stack naturally
2. Change `gap: 0` to `gap: var(--mm-space-1)` or similar - Add spacing between rows
3. Keep `flex: 1` but remove `justify-content: space-evenly` - Allow natural stacking

**Changes to `.barRow`:**
- Already fixed (removed `flex: 1`, changed `align-items: start`)
- May need to adjust `padding-block` if gap is added to parent

**Guarantees:**
- ✅ Rows grow with content height (no `flex: 1` on rows, no `space-evenly`)
- ✅ No overlap between adjacent rows (proper gap, natural stacking)
- ✅ Bar track and value alignment stays correct (already fixed with `align-self: center`)
- ✅ No clipping, no scroll, no truncation (already fixed with wrapping properties)

---

## Corrected Fix Applied

**Changes to `.barElements`:**
1. ✅ Changed `justify-content: space-evenly` to `flex-start` - Rows now stack naturally
2. ✅ Changed `gap: 0` to `gap: var(--mm-space-1)` - Added spacing between rows
3. ✅ Added `align-items: stretch` - Rows stretch to full width
4. ✅ Kept `flex: 1` but removed `space-evenly` - Allows natural stacking

**Changes to `.barRow`:**
- ✅ Removed `padding-block` - Gap is now handled by parent `.barElements`
- ✅ Already fixed (removed `flex: 1`, changed `align-items: start`)

**Guarantees:**
- ✅ Rows grow with content height (no `flex: 1` on rows, no `space-evenly`)
- ✅ No overlap between adjacent rows (proper gap, natural stacking)
- ✅ Bar track and value alignment stays correct (`align-self: center`)
- ✅ No clipping, no scroll, no truncation (wrapping properties in place)

**Local Gate Results:**
- Build: ✅ Pass
- Linting: ✅ No errors
- TypeScript: ✅ No errors

**Files Modified:**
- `app/report/[slug]/ReportChart.module.css` (`.barElements` and `.barRow`)

**Commits:**
- `ae9aaef07` - fix(p1-1.5): Corrected BAR chart label overlap fix
- `b37e807d1` - docs(p1-1.5): Update audit plan with corrected BAR chart label overlap fix

**Next Steps:**
1. Push to preview branch (Sultan required)
2. Preview verification on canonical preview URL
3. Test with page that has multi-line labels (e.g., "Automotive (CPL: €170)")
4. Document evidence (URL, page, viewport, expected vs observed, screenshots if needed)
