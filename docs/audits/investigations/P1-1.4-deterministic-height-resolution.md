# P1 1.4 – Deterministic Height Resolution Investigation

**Date:** 2026-01-10T12:13:23.300Z  
**Status:** Investigation Only (No Fixes)  
**Investigator:** Tribeca

---

## Objective

Identify and document where height behavior is:
- **implicit** (inferred from parent/context)
- **inferred** (calculated from other properties)
- **content-driven** (determined by content size)
- **ratio-based without deterministic enforcement** (flex ratios without explicit height constraints)

across report layouts.

---

## Height Ownership Table

| Component | Height Owner | Enforcement Method | Risk Level | Notes |
|-----------|--------------|-------------------|------------|-------|
| **Block/Row** | `ResponsiveRow` component | CSS custom property `--row-height` / `--block-height` set via `solveBlockHeightWithImages()` | ✅ **SAFE** | Deterministic calculation from cell distribution and image aspect ratios |
| **Chart Container** (`.chart`) | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set (implicit) |
| **Chart Body** (`.chartBody`) | Parent chart container | `flex: 1` with `min-height: 0` | ⚠️ **FRAGILE** | Relies on flex growth without explicit height constraints |
| **KPI Chart** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` + internal grid `grid-template-rows: 4fr 3fr 3fr` | ✅ **SAFE** | Deterministic within block height, ratio-based but enforced |
| **KPI Icon Row** | KPI grid (4fr) | `height: 100%` within grid row | ✅ **SAFE** | Grid row height is deterministic |
| **KPI Value Row** | KPI grid (3fr) | `height: 100%` within grid row | ✅ **SAFE** | Grid row height is deterministic |
| **KPI Title Row** | KPI grid (3fr) | `height: 100%` within grid row | ✅ **SAFE** | Grid row height is deterministic |
| **PIE Chart Container** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set |
| **PIE Grid** (`.pieGrid`) | PIE chart container | `height: 100%` | ✅ **SAFE** | Inherits from parent |
| **PIE Title Row** | PIE grid flex | `flex: 0 0 30%` | ✅ **SAFE** | Fixed 30% of pie grid height |
| **PIE Chart Container** (Chart.js) | PIE grid flex | `flex: 0 0 40%` with `min-height: 100px` | ⚠️ **FRAGILE** | Fixed 40% but has minimum height constraint that may override in small containers |
| **PIE Legend** | PIE grid flex | `flex: 1 1 30%` with `min-height: 60px` | ⚠️ **FRAGILE** | Prefers 30% but can grow; minimum height may cause issues in constrained spaces |
| **Bar Chart** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set |
| **Bar Chart Body** | Bar chart container | `flex: 1` with `min-height: 0` | ⚠️ **FRAGILE** | Relies on flex growth without explicit height constraints |
| **Bar Row** | Bar chart body | `min-height: 0` | ⚠️ **FRAGILE** | Relies on content-driven height |
| **Bar Track** | Bar row | `height: clamp(1.2rem, 22cqh, 1.44rem)` | ✅ **SAFE** | Container query-based, deterministic |
| **Text Chart** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set |
| **Text Chart Body** | Text chart container | `flex: 1` with `min-height: 0` | ⚠️ **FRAGILE** | Relies on flex growth without explicit height constraints |
| **Text Content** | Text chart body | `height: 100%` with `min-height: 0` | ⚠️ **FRAGILE** | Relies on parent height, could be implicit |
| **Table Chart** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set |
| **Table Content** | Table chart container | `height: 100%` | ⚠️ **FRAGILE** | Relies on parent height |
| **Image Chart** | Parent row via CSS variable | `height: var(--block-height, var(--row-height, 100%))` | ⚠️ **FRAGILE** | Falls back to `100%` if CSS variables not set |
| **Image Container** | Image chart container | `height: 100%` with `object-fit: contain` | ✅ **SAFE** | Inherits from parent, aspect ratio preserved |
| **CellWrapper** | Parent (not used in reports) | No explicit height | ❌ **UNDEFINED** | Not used in report layouts, but exists as component |
| **Row Item** (`.rowItem`) | Parent row grid | `height: 100%` | ✅ **SAFE** | Inherits from row height |
| **Row** (`.row`) | ResponsiveRow component | `height: var(--row-height, auto)` with `min-height: var(--row-height, auto)` | ⚠️ **FRAGILE** | Falls back to `auto` if CSS variable not set |

---

## Detailed Findings

### 1. Block/Row Height Calculation (✅ SAFE)

**Location:** `lib/blockHeightCalculator.ts`, `app/report/[slug]/ReportContent.tsx`

**Enforcement Method:**
- Height calculated deterministically using `solveBlockHeightWithImages()`
- Formula: `H = blockWidth / totalEffectiveUnits`
- Applied via CSS custom property `--row-height` and `--block-height` on row container
- Recalculated on resize via ResizeObserver

**Risk Assessment:** ✅ **SAFE**
- Deterministic calculation from cell distribution and image aspect ratios
- Explicit height set via CSS custom property
- Recalculated on dimension changes

**Potential Issues:**
- None identified - this is the source of truth for height

---

### 2. Chart Container Height (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:14`

**Enforcement Method:**
```css
height: var(--block-height, var(--row-height, 100%));
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Falls back to `100%` if CSS variables not set (implicit behavior)
- If parent row height is not set, chart height becomes `100%` of undefined parent
- Could result in `auto` height if parent has no explicit height

**Potential Issues:**
- If `--block-height` and `--row-height` are not set, height becomes implicit
- In SSR or initial render, CSS variables may not be available
- Could break when content length changes if parent height is not deterministic

---

### 3. Chart Body Flex Growth (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:38-46`

**Enforcement Method:**
```css
.chartBody {
  flex: 1; /* Expand to fill available space */
  min-height: 0; /* Allow flex shrinking if needed */
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Relies on flex growth without explicit height constraints
- Depends on parent chart container having explicit height
- `min-height: 0` allows shrinking, which could cause content clipping

**Potential Issues:**
- If parent chart container height is implicit, flex growth may not work correctly
- Content-driven height could cause layout shifts
- May break when content length changes significantly

---

### 4. PIE Chart Container Minimum Height (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:283-296`

**Enforcement Method:**
```css
.pieChartContainer {
  flex: 0 0 40%; /* Fixed 40% */
  min-height: 100px; /* CRITICAL: Reduced from 150px */
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Fixed 40% flex basis but has minimum height constraint
- In small containers (e.g., 1 unit in 5-unit block), minimum height may override flex ratio
- Could cause pie chart to exceed intended 40% allocation

**Potential Issues:**
- Minimum height may override flex ratio in constrained spaces
- Could break 30:40:30 ratio when block height is small
- May cause legend to be clipped if pie chart takes more than 40%

---

### 5. PIE Legend Flex Growth (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:299-317`

**Enforcement Method:**
```css
.pieLegend {
  flex: 1 1 30%; /* Prefers 30%, but can grow if needed */
  min-height: 60px; /* CRITICAL: Prevent collapse on mobile */
  overflow: visible; /* Container grows to fit */
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Prefers 30% but can grow beyond that
- Minimum height constraint may cause issues in constrained spaces
- Growth behavior is not bounded (no max-height)

**Potential Issues:**
- Could grow beyond intended 30% allocation if legend items are numerous
- Minimum height may cause layout issues in very small containers
- No maximum height constraint could cause legend to dominate pie chart area

---

### 6. Text Chart Content Height (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:542-573`

**Enforcement Method:**
```css
.textContent {
  height: 100%; /* Fill parent height completely */
  min-height: 0; /* Allow flex shrinking */
  max-height: 100%; /* Don't exceed parent height */
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Relies on parent height being explicit
- If parent height is implicit, `100%` becomes undefined
- `min-height: 0` allows shrinking, which could cause content clipping

**Potential Issues:**
- If parent text chart body height is implicit, content height becomes undefined
- Content-driven height could cause layout shifts
- May break when content length changes significantly

---

### 7. Bar Chart Body Flex Growth (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportChart.module.css:369-380`

**Enforcement Method:**
```css
.bar .chartBody {
  flex: 1;
  min-height: 0;
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Relies on flex growth without explicit height constraints
- Depends on parent chart container having explicit height
- `min-height: 0` allows shrinking

**Potential Issues:**
- If parent chart container height is implicit, flex growth may not work correctly
- Content-driven height could cause layout shifts
- May break when bar count or label length changes

---

### 8. Row Height Fallback (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportContent.module.css:89-90`

**Enforcement Method:**
```css
.row {
  height: var(--row-height, auto);
  min-height: var(--row-height, auto);
}
```

**Risk Assessment:** ⚠️ **FRAGILE**
- Falls back to `auto` if CSS variable not set
- If `--row-height` is not set, row height becomes content-driven
- Could break when content length changes

**Potential Issues:**
- If CSS variable is not set (e.g., SSR, initial render), height becomes implicit
- Content-driven height could cause layout shifts
- May break when chart count or content length changes

---

### 9. Responsive Height Recalculation (⚠️ FRAGILE)

**Location:** `app/report/[slug]/ReportContent.tsx:205-265`

**Enforcement Method:**
- Height recalculated on resize via ResizeObserver
- Recalculated when `rowCharts` or `chartResults` change
- Uses `solveBlockHeightWithImages()` for calculation

**Risk Assessment:** ⚠️ **FRAGILE**
- Height recalculated asynchronously (after render)
- Could cause layout shift if calculation is delayed
- Depends on `rowRef.current.offsetWidth` being accurate

**Potential Issues:**
- Initial render may have incorrect height if width measurement is delayed
- Layout shift if height recalculation happens after content is rendered
- May break if ResizeObserver is not supported or fails

---

### 10. CellWrapper Height (❌ UNDEFINED)

**Location:** `components/CellWrapper.tsx`

**Enforcement Method:**
- No explicit height set
- Relies on parent for height

**Risk Assessment:** ❌ **UNDEFINED**
- Not used in report layouts (charts use direct grid/flex layouts)
- Height behavior is undefined if used elsewhere

**Potential Issues:**
- If used in future, height behavior is not defined
- Could cause layout issues if parent height is implicit

---

## Summary of Risk Levels

- ✅ **SAFE (8 components):** Deterministic height enforcement with explicit constraints
- ⚠️ **FRAGILE (11 components):** Height relies on implicit behavior, flex growth without constraints, or fallback values
- ❌ **UNDEFINED (1 component):** Height behavior not defined (CellWrapper, not used in reports)

---

## Potential Breakage Scenarios

### Scenario 1: CSS Variable Not Set
**Trigger:** SSR, initial render, or CSS variable not applied  
**Impact:** Chart containers fall back to `100%` or `auto`, causing implicit height behavior  
**Components Affected:** All chart containers, row height

### Scenario 2: Content Length Changes
**Trigger:** Chart data changes, text content grows/shrinks  
**Impact:** Flex growth may not accommodate content, causing clipping or overflow  
**Components Affected:** Chart body, text content, bar chart body

### Scenario 3: Responsive Breakpoint Shift
**Trigger:** Viewport width changes, grid columns change  
**Impact:** Height recalculation may be delayed, causing layout shift  
**Components Affected:** Row height, all chart containers

### Scenario 4: Small Container Constraints
**Trigger:** Block height is small (e.g., 4+ element blocks)  
**Impact:** Minimum height constraints may override flex ratios  
**Components Affected:** PIE chart container, PIE legend

### Scenario 5: Chart Type Changes
**Trigger:** Chart type changes from one to another  
**Impact:** Height requirements may differ, causing layout shift  
**Components Affected:** All chart containers

---

## Investigation Complete

**Status:** ✅ Investigation complete, no fixes applied  
**Next Steps:** Await review and approval before proceeding to solution proposals

---

## Files Examined

- `lib/blockHeightCalculator.ts` - Block height calculation logic
- `app/report/[slug]/ReportContent.tsx` - Row height management
- `app/report/[slug]/ReportContent.module.css` - Row styles
- `app/report/[slug]/ReportChart.module.css` - Chart container and content styles
- `components/CellWrapper.tsx` - Cell wrapper component (not used in reports)
- `docs/design/LAYOUT_GRAMMAR.md` - Layout Grammar specification
- `docs/design/LAYOUT_SYSTEM.md` - Layout system documentation
