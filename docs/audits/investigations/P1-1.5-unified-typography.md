# P1 1.5 Unified Typography Investigation

**Date:** 2026-01-10T13:15:36.757Z  
**Status:** Investigation Complete  
**Investigator:** Tribeca  
**Reference:** `COMPREHENSIVE_SYSTEM_AUDIT_PLAN_2026.md` Section 1.5

---

## Investigation Goal

Verify compliance with Unified Typography specification:
- Each Block computes exactly one value: `--block-base-font-size`
- This applies to: Text Elements, Markdown headings, Chart labels, Chart legends, Table headers/cells, Descriptions/captions
- **Explicit Exemption:** KPI values scale independently (KPI label + description still participate)

---

## Specification Reference

From `UNIFIED_DESIGN_SYSTEM_MASTER_PLAN.md` and `DESIGN_SYSTEM_PLAN.md`:

### Block Typography Contract

**Each Block computes exactly one value: `--block-base-font-size`**

**Applies to:**
- ✅ Text Elements (base)
- ✅ Markdown headings (H1/H2/H3 via em multipliers)
- ✅ Chart labels
- ✅ Chart legends
- ✅ Table headers and cells
- ✅ Descriptions / captions

**Exemption:**
- ❌ **KPI value only** (KPI label + description still participate)

---

## Investigation Results

### 1. Block-Level Title Font Size

**Rule:** All titles in a block should share the same font size.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx`
- **Lines:** 238-245
- **Code:**
```typescript
const syncedFonts = calculateSyncedFontSizes(cells, width, {
  maxTitleLines: 2,
  maxSubtitleLines: 2,
  enableKPISync: false
});
setTitleFontSize(syncedFonts.titlePx);
setSubtitleFontSize(syncedFonts.subtitlePx);
```

**Finding:** ❌ **FAIL**
- Font sizes are calculated **per row**, not per block
- Each `ResponsiveRow` component calculates its own `titleFontSize` and `subtitleFontSize`
- Multiple rows in a block will have different title font sizes
- **Violation:** Block-level unification not implemented

**Evidence:**
- `calculateSyncedFontSizes` is called within `ResponsiveRow` component (line 238)
- Each row independently calculates font sizes based on its own width and cell configurations
- No block-level aggregation or unification of title font sizes

---

### 2. Block-Level Subtitle Font Size

**Rule:** All subtitles in a block should share the same font size.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx`
- **Lines:** 238-245
- **Code:** Same as titles (see above)

**Finding:** ❌ **FAIL**
- Font sizes are calculated **per row**, not per block
- Each `ResponsiveRow` component calculates its own `subtitleFontSize`
- Multiple rows in a block will have different subtitle font sizes
- **Violation:** Block-level unification not implemented

**Evidence:**
- Same as titles - `calculateSyncedFontSizes` is called per row
- No block-level aggregation

---

### 3. Chart Title Font Size

**Rule:** Chart titles should use unified block typography.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css`
- **Line:** 51
- **Code:**
```css
.chartTitle {
  font-size: clamp(0.9rem, 2.8cqw, 1.25rem);
  ...
}
```

**Finding:** ❌ **FAIL**
- Chart titles use responsive container query scaling (`2.8cqw`)
- Not unified with block-level typography
- Each chart title scales independently based on its container width
- **Violation:** Chart titles do not participate in unified typography

**Evidence:**
- Chart titles use `clamp(0.9rem, 2.8cqw, 1.25rem)` which is responsive per chart
- No reference to `--block-base-font-size` or unified typography system
- Chart titles are rendered via `CellWrapper` component which receives `titleFontSize` prop, but CSS overrides it

**Additional Finding:**
- **File:** `components/CellWrapper.module.css`
- **Line:** 21
- **Code:**
```css
.titleZone {
  font-size: var(--title-font-size); /* Uses CSS custom property */
}
```
- `CellWrapper` receives `titleFontSize` prop and sets `--title-font-size` CSS variable
- However, this is per-row, not per-block
- Chart titles in `ReportChart.module.css` override this with their own responsive scaling

---

### 4. Chart Subtitle Font Size

**Rule:** Chart subtitles should use unified block typography.

**Current Implementation:**
- **File:** `components/CellWrapper.module.css`
- **Line:** 49
- **Code:**
```css
.subtitleZone {
  font-size: var(--subtitle-font-size); /* Uses CSS custom property */
}
```

**Finding:** ⚠️ **PARTIAL PASS**
- Subtitles use CSS custom property `--subtitle-font-size`
- This is set per-row via `CellWrapper` props
- **Issue:** Not unified at block level (same as titles)

**Evidence:**
- `CellWrapper` receives `subtitleFontSize` prop and sets `--subtitle-font-size`
- This is calculated per-row, not per-block

---

### 5. KPI Value Font Size (Exemption)

**Rule:** KPI values scale independently (explicit exemption).

**Current Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css`
- **Line:** 143
- **Code:**
```css
.kpiValueRow {
  font-size: clamp(1.25rem, min(30cqh, 25cqw), 6rem);
  ...
}
```

**Finding:** ✅ **PASS**
- KPI values use independent responsive scaling
- Not unified with block typography
- **Compliant:** This is the explicit exemption per specification

**Evidence:**
- KPI values use `clamp(1.25rem, min(30cqh, 25cqw), 6rem)` which is independent
- No reference to unified typography system
- Matches specification exemption

---

### 6. KPI Label Font Size

**Rule:** KPI labels should participate in unified typography (not exempt).

**Current Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css`
- **Line:** 169
- **Code:**
```css
.kpi .kpiTitle {
  font-size: clamp(0.75rem, 15cqh, 1.5rem);
  ...
}
```

**Finding:** ❌ **FAIL**
- KPI labels use independent responsive scaling (`15cqh`)
- Not unified with block typography
- **Violation:** KPI labels should participate in unified typography per specification

**Evidence:**
- KPI labels use `clamp(0.75rem, 15cqh, 1.5rem)` which is independent
- No reference to unified typography system
- Specification states: "KPI label + description still participate unless you later exempt them"

---

### 7. Text Chart Font Size

**Rule:** Text charts should use unified typography within a block.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportContent.tsx`
- **Lines:** 451-453
- **Code:**
```typescript
style={unifiedTextFontSize ? {
  '--unified-text-font-size': `${unifiedTextFontSize}rem`
} as React.CSSProperties : undefined}
```

- **File:** `hooks/useUnifiedTextFontSize.ts`
- **Lines:** 20-214
- **Implementation:** Calculates unified font size for all text charts in a block

**Finding:** ✅ **PASS**
- Text charts use `--unified-text-font-size` CSS custom property
- Calculated at block level via `useUnifiedTextFontSize` hook
- All text charts in a block share the same font size
- **Compliant:** Matches specification requirement

**Evidence:**
- `useUnifiedTextFontSize` hook calculates unified size for all text charts in a block
- Sets `--unified-text-font-size` on block container
- Text charts consume this via CSS: `font-size: var(--unified-text-font-size, clamp(...))`

---

### 8. Chart Labels and Legends

**Rule:** Chart labels and legends should use unified block typography.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css`
- **Various lines:** Bar labels, pie legend text, etc. use independent responsive scaling

**Finding:** ❌ **FAIL**
- Chart labels and legends use independent responsive scaling (container queries)
- Not unified with block typography
- **Violation:** Chart labels and legends do not participate in unified typography

**Evidence:**
- Bar labels: Use `clamp()` with container queries
- Pie legend text: Use `clamp()` with container queries
- No reference to `--block-base-font-size` or unified typography system

---

### 9. Table Headers and Cells

**Rule:** Table headers and cells should use unified block typography.

**Current Implementation:**
- **File:** `app/report/[slug]/ReportChart.module.css`
- **Lines:** Various (table markdown styles)

**Finding:** ⚠️ **NEEDS VERIFICATION**
- Table styles inherit from markdown rendering
- Need to verify if tables use unified typography or independent scaling

**Evidence:**
- Tables are rendered via markdown parser
- Styles may inherit from parent container
- Requires further investigation of table-specific font sizing

---

## Summary

### PASS ✅
1. **KPI Values:** Scale independently (explicit exemption) - ✅ PASS
2. **Text Charts:** Use unified typography at block level - ✅ PASS

### FAIL ❌
1. **Block-Level Titles:** Calculated per-row, not per-block - ❌ FAIL
2. **Block-Level Subtitles:** Calculated per-row, not per-block - ❌ FAIL
3. **Chart Titles:** Use independent responsive scaling, not unified - ❌ FAIL
4. **KPI Labels:** Use independent scaling, should participate in unified typography - ❌ FAIL
5. **Chart Labels/Legends:** Use independent scaling, not unified - ❌ FAIL

### PARTIAL / NEEDS VERIFICATION ⚠️
1. **Chart Subtitles:** Use CSS custom property but per-row, not per-block - ⚠️ PARTIAL
2. **Table Headers/Cells:** Need further investigation - ⚠️ NEEDS VERIFICATION

---

## Violations Summary

### Critical Violations (Block-Level Unification Missing)

1. **Titles and Subtitles:** Calculated per-row instead of per-block
   - **File:** `app/report/[slug]/ReportContent.tsx:238-245`
   - **Impact:** Multiple rows in a block have different title/subtitle font sizes
   - **Fix Required:** Move font size calculation to block level, calculate once per block, apply to all rows

2. **Chart Titles:** Override unified typography with independent responsive scaling
   - **File:** `app/report/[slug]/ReportChart.module.css:51`
   - **Impact:** Chart titles do not participate in unified typography
   - **Fix Required:** Remove responsive scaling, use unified block typography

3. **KPI Labels:** Use independent scaling instead of unified typography
   - **File:** `app/report/[slug]/ReportChart.module.css:169`
   - **Impact:** KPI labels do not participate in unified typography (should participate per spec)
   - **Fix Required:** Use unified block typography instead of independent scaling

4. **Chart Labels/Legends:** Use independent scaling instead of unified typography
   - **File:** `app/report/[slug]/ReportChart.module.css` (various)
   - **Impact:** Chart labels and legends do not participate in unified typography
   - **Fix Required:** Use unified block typography instead of independent scaling

---

## Recommendations

### High Priority
1. **Implement Block-Level Font Size Calculation:**
   - Move `calculateSyncedFontSizes` call from `ResponsiveRow` to `ReportBlock`
   - Calculate once per block, apply to all rows
   - Set `--block-base-font-size` CSS custom property on block container

2. **Unify Chart Titles:**
   - Remove responsive scaling from `.chartTitle` in `ReportChart.module.css`
   - Use unified block typography via CSS custom property

3. **Unify KPI Labels:**
   - Remove independent scaling from `.kpi .kpiTitle`
   - Use unified block typography

4. **Unify Chart Labels/Legends:**
   - Replace independent responsive scaling with unified block typography
   - Apply `--block-base-font-size` to all chart labels and legends

### Medium Priority
1. **Verify Table Typography:**
   - Investigate table header and cell font sizing
   - Ensure tables participate in unified typography

---

## Next Steps

**Status:** Investigation complete. No fixes applied.

**Deliverable:** This investigation document with PASS/FAIL classification per block title/subtitle rules, explicit exemptions (KPI value), and file paths/line references.

**Awaiting:** Approval to proceed with fixes (if authorized).

---

## Files Referenced

1. `app/report/[slug]/ReportContent.tsx` - Row-level font size calculation
2. `app/report/[slug]/ReportChart.module.css` - Chart title, KPI, label, legend styles
3. `components/CellWrapper.module.css` - Title/subtitle zone styles
4. `components/CellWrapper.tsx` - Title/subtitle props
5. `hooks/useUnifiedTextFontSize.ts` - Text chart unified typography
6. `lib/fontSyncCalculator.ts` - Font size calculation logic
