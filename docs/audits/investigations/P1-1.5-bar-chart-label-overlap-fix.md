# P1 1.5 BAR Chart Label Overlap Fix

**Date:** 2026-01-11T08:55:00.000Z  
**Status:** Investigation Complete  
**Investigator:** Tribeca  
**Reference:** Layout Grammar violation - content collision/clipping

---

## Problem

BAR chart labels that wrap to 2 lines (e.g., "Automotive (CPL: €170)") overlap neighboring labels. This is a Layout Grammar violation (content collision is effectively clipping).

---

## Root Cause

**Current Implementation Issues:**

1. **`.barRow` has `flex: 1`** - Forces all rows to equal height, preventing multi-line labels from expanding row height
2. **`.barRow` uses `align-items: center`** - Centers content vertically, causing overlap when labels are taller
3. **`.barLabel` has conflicting display properties** - Uses both `-webkit-line-clamp: 2` (line clamp) and `display: flex` (conflicting)
4. **No proper wrapping** - Label doesn't properly wrap to multiple lines without overlap

---

## Current Structure

```css
.barElements {
  display: flex;
  flex-direction: column;
  gap: 0;
  flex: 1;
  justify-content: space-evenly;
}

.barRow {
  display: grid;
  grid-template-columns: 25% 1fr 25%;
  gap: 0 var(--mm-space-2);
  align-items: center; /* ❌ Causes overlap */
  flex: 1; /* ❌ Prevents row growth */
  padding: 0 var(--mm-space-1);
}

.barLabel {
  display: -webkit-box; /* ❌ Line clamp */
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  display: flex; /* ❌ Conflicting with -webkit-box */
  align-items: center;
  justify-content: flex-end;
  line-height: 1.1;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
```

---

## Solution

**Changes Required:**

1. **Remove `flex: 1` from `.barRow`** - Allow rows to grow with content
2. **Change `.barRow` to `align-items: start`** - Align labels at top, prevent overlap
3. **Fix `.barLabel` wrapping** - Remove line clamp, use proper wrapping properties
4. **Add proper spacing** - Use `padding-block` and `row-gap` for vertical spacing
5. **Align bar/value with first line** - Use `align-self: center` or `start` for bar/value cells

---

## Implementation Plan

1. Update `.barRow`:
   - Remove `flex: 1`
   - Change `align-items: center` to `align-items: start`
   - Add `padding-block: var(--mm-space-1)`
   - Ensure `row-gap` is handled by padding or gap

2. Update `.barLabel`:
   - Remove `-webkit-line-clamp: 2`
   - Remove `-webkit-box` display
   - Keep `display: flex` but change to `flex-direction: column`
   - Add `white-space: normal`
   - Add `overflow-wrap: anywhere`
   - Add `word-break: break-word`
   - Set `line-height: 1.15`
   - Remove `align-items: center` (or change to `start`)

3. Update `.barTrack` and `.barValue`:
   - Add `align-self: center` to align with first line of label (or `start` if preferred)

---

## Expected Behavior

- Multi-line labels expand row height
- Labels wrap safely without overlap
- Bar and value align with first line of label (or center within row)
- No content collision or clipping
- Layout Grammar compliance maintained

---

## Files to Modify

- `app/report/[slug]/ReportChart.module.css` (BAR chart styles only)

---

## Implementation Complete

**Changes Applied:**

1. **`.barRow` updated:**
   - Removed `flex: 1` - Rows now grow with content
   - Changed `align-items: center` to `align-items: start` - Labels align at top
   - Changed `grid-template-columns` to `minmax(0, 25%) minmax(0, 1fr) auto` - Better column sizing
   - Changed `gap: 0 var(--mm-space-2)` to `column-gap: var(--mm-space-3); row-gap: var(--mm-space-1)` - Proper spacing
   - Added `padding-block: var(--mm-space-1)` - Vertical spacing between rows

2. **`.barLabel` updated:**
   - Removed `-webkit-line-clamp: 2` - Allow unlimited wrapping
   - Removed `-webkit-box` display - No line clamp
   - Changed to `display: flex; flex-direction: column` - Stack lines vertically
   - Changed `align-items: center` to `align-items: flex-end` - Right-align text
   - Changed `justify-content: flex-end` to `justify-content: flex-start` - Align to top
   - Added `white-space: normal` - Allow wrapping
   - Added `overflow-wrap: anywhere` - Break words if needed
   - Added `word-break: break-word` - Break long words
   - Changed `line-height: 1.1` to `line-height: 1.15` - Deterministic line-height

3. **`.barTrack` updated:**
   - Added `align-self: center` - Align bar with first line of label

4. **`.barValue` updated:**
   - Added `white-space: nowrap` - Values should not wrap
   - Added `align-self: center` - Align value with first line of label
   - Removed `word-wrap: break-word` and `overflow-wrap: break-word` - Values are single line

**Local Gate Results:**
- Build: ✅ Pass
- Linting: ✅ No errors
- TypeScript: ✅ No errors

**Files Modified:**
- `app/report/[slug]/ReportChart.module.css` (BAR chart styles only)

**Next Steps:**
- Commit changes
- Preview verification on canonical preview URL
- Test with page that has multi-line labels (e.g., "Automotive (CPL: €170)")
- Document evidence (URL, page, expected vs observed)
