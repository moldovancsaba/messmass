# P0 3.3 – Design Tokens & Style Ownership Definition

**Date:** 2026-01-09T20:14:01.300Z  
**Status:** INVESTIGATION  
**Priority:** P0 - CRITICAL  
**Owner:** Tribeca (Investigation), Chappie (Approval)

---

## Executive Summary

This document defines the design token strategy, style ownership rules, and migration boundaries for the MessMass system. It serves as the architectural foundation before remediation of 2,624 hardcoded values and 146 inline styles identified in P0 3.1 and P0 3.2 audits.

**Purpose:** Establish clear rules for what becomes a token, where tokens live, who owns them, and how new tokens are introduced. This prevents style regressions and ensures long-term maintainability.

---

## 1. Design Token Strategy

### 1.1 Token Categories

Design tokens are organized into the following categories:

#### **Global Tokens** (app/styles/theme.css)
- **Colors:** Primary, secondary, grayscale, semantic, chart colors
- **Typography:** Font families, sizes, weights, line heights, letter spacing
- **Spacing:** 8px grid system (--mm-space-0 through --mm-space-24)
- **Border Radius:** --mm-radius-none through --mm-radius-2xl
- **Shadows:** --mm-shadow-xs through --mm-shadow-2xl
- **Z-Index:** --z-base through --z-tooltip
- **Transitions:** --transition-fast, --transition-normal, --transition-slow

#### **Chart-Specific Tokens** (app/styles/theme.css)
- **Chart Colors:** --chartBackground, --chartBorder, --chartTitleColor, --chartLabelColor, --chartValueColor
- **KPI Tokens:** --kpiIconColor
- **Bar Chart Tokens:** --barColor1 through --barColor5
- **Pie Chart Tokens:** --pieColor1, --pieColor2
- **Chart State Tokens:** --chartNoDataBackground, --chartErrorBackground, --chartTooltipBackground

#### **Component-Scoped Tokens** (Component CSS Modules)
- **Allowed:** Component-specific tokens that are NOT reusable across components
- **Naming:** `--component-name-property` (e.g., `--modal-overlay-opacity`)
- **Scope:** Limited to the component's CSS module file
- **Rule:** If a token is used in 2+ components, it MUST be moved to global tokens

### 1.2 What Becomes a Token

#### **MUST Become a Token:**
1. **Colors:**
   - All hex colors (#[0-9a-fA-F]{3,6})
   - All RGB/RGBA values
   - All named colors (except `transparent`, `currentColor`, `inherit`)

2. **Spacing:**
   - All pixel values for padding, margin, gap
   - All rem/em values for spacing (unless part of typography scale)
   - Exception: `0` (zero) is allowed without token

3. **Typography:**
   - Font sizes (px, rem, em)
   - Font weights (numeric values)
   - Line heights (unitless or with units)
   - Letter spacing

4. **Sizing:**
   - Border radius values
   - Border widths
   - Shadow values
   - Z-index values (must use --z-* tokens)

5. **Repeated Values:**
   - Any value used in 2+ places
   - Any value that might change with design system updates

#### **DOES NOT Become a Token:**
1. **Contextual Values:**
   - `100%`, `50%`, `auto`, `none`, `inherit`, `initial`, `unset`
   - `0` (zero) for spacing
   - `transparent`, `currentColor`
   - `calc()` expressions (but values inside calc should use tokens)

2. **Dynamic/Runtime Values:**
   - Values computed from props/state
   - Values from database (e.g., PageStyle colors)
   - Values from user input

3. **Layout-Specific:**
   - `flex: 1`, `flex: 0`, `flex: auto`
   - `grid-template-columns: repeat(...)`
   - Container query units (`cqh`, `cqw`)

### 1.3 Where Tokens Live

#### **Global Tokens: `app/styles/theme.css`**
- **Location:** `app/styles/theme.css` (lines 1-450)
- **Scope:** `:root` selector
- **Prefix:** `--mm-*` for MessMass tokens
- **Chart Prefix:** `--chart*` for chart-specific tokens
- **Z-Index Prefix:** `--z-*` for z-index tokens
- **Ownership:** Design System Team (Chappie/Tribeca)

#### **Component-Scoped Tokens: Component CSS Modules**
- **Location:** `components/*.module.css` or `app/**/*.module.css`
- **Scope:** Component-specific CSS module
- **Naming:** `--component-name-property`
- **Ownership:** Component owner
- **Rule:** Must be documented in component CSS comments

---

## 2. Global vs Component-Scoped Strategy

### 2.1 Global Tokens (app/styles/theme.css)

**Use Global Tokens When:**
- Value is used in 2+ components
- Value is part of the design system (colors, spacing, typography)
- Value needs to be themeable or changeable system-wide
- Value is a standard design system value (e.g., primary color, standard spacing)

**Examples:**
```css
/* ✅ CORRECT: Global token */
.component {
  color: var(--mm-gray-900);
  padding: var(--mm-space-4);
  border-radius: var(--mm-radius-lg);
}

/* ❌ FORBIDDEN: Hardcoded value */
.component {
  color: #111827;
  padding: 16px;
  border-radius: 8px;
}
```

### 2.2 Component-Scoped Tokens

**Use Component-Scoped Tokens When:**
- Value is unique to a single component
- Value is not part of the design system
- Value is a component-specific implementation detail
- Value should NOT be reused elsewhere

**Examples:**
```css
/* ✅ CORRECT: Component-scoped token */
/* components/Modal.module.css */
.modal {
  --modal-overlay-opacity: 0.5;
  --modal-backdrop-blur: 8px;
}

.modalOverlay {
  opacity: var(--modal-overlay-opacity);
  backdrop-filter: blur(var(--modal-backdrop-blur));
}

/* ❌ FORBIDDEN: Component-specific token used globally */
/* This should be in component CSS module, not theme.css */
```

### 2.3 Migration Rule

**If a component-scoped token is used in 2+ components:**
1. Move token to `app/styles/theme.css`
2. Rename to follow `--mm-*` naming convention
3. Update all component references
4. Document in RELEASE_NOTES.md

---

## 3. Spacing and Sizing Strategy

### 3.1 Spacing Scale (8px Grid System)

**Base Unit:** 8px (`--mm-space-2`)

**Scale:**
- `--mm-space-0`: 0px
- `--mm-space-1`: 4px
- `--mm-space-2`: 8px (base unit)
- `--mm-space-3`: 12px
- `--mm-space-4`: 16px
- `--mm-space-5`: 20px
- `--mm-space-6`: 24px
- `--mm-space-8`: 32px
- `--mm-space-10`: 40px
- `--mm-space-12`: 48px
- `--mm-space-16`: 64px
- `--mm-space-20`: 80px
- `--mm-space-24`: 96px

**Rule:** All spacing MUST use tokens from this scale. No custom spacing values allowed.

**Exception:** Container query units (`cqh`, `cqw`) are allowed for responsive typography and layout.

### 3.2 Typography Scale

**Font Sizes:**
- `--mm-font-size-xs`: 12px (0.75rem)
- `--mm-font-size-sm`: 14px (0.875rem)
- `--mm-font-size-base`: 16px (1rem)
- `--mm-font-size-lg`: 18px (1.125rem)
- `--mm-font-size-xl`: 20px (1.25rem)
- `--mm-font-size-2xl`: 24px (1.5rem)
- `--mm-font-size-3xl`: 30px (1.875rem)
- `--mm-font-size-4xl`: 36px (2.25rem)

**Font Weights:**
- `--mm-font-weight-normal`: 400
- `--mm-font-weight-medium`: 500
- `--mm-font-weight-semibold`: 600
- `--mm-font-weight-bold`: 700

**Rule:** All typography MUST use tokens. No hardcoded font sizes or weights.

**Exception:** Responsive typography using `clamp()` with container queries is allowed.

### 3.3 Sizing Strategy

**Border Radius:**
- `--mm-radius-none`: 0px
- `--mm-radius-sm`: 4px
- `--mm-radius-md`: 8px
- `--mm-radius-lg`: 12px
- `--mm-radius-xl`: 16px
- `--mm-radius-2xl`: 24px

**Shadows:**
- `--mm-shadow-xs`: Minimal shadow
- `--mm-shadow-sm`: Small shadow
- `--mm-shadow-md`: Medium shadow
- `--mm-shadow-lg`: Large shadow
- `--mm-shadow-xl`: Extra large shadow
- `--mm-shadow-2xl`: Maximum shadow

**Rule:** All sizing values MUST use tokens. No hardcoded pixel values for borders, shadows, or radius.

---

## 4. Inline Style Rules

### 4.1 Explicit List: What is Allowed

#### **ALLOWED (Dynamic-Only):**

1. **CSS Custom Property Injection:**
   ```tsx
   // ✅ ALLOWED: Injects CSS variable for dynamic theming
   <div style={{ ['--active-font' as string]: fontMap[selectedFont] } as React.CSSProperties}>
   ```

2. **Runtime Computed Values:**
   ```tsx
   // ✅ ALLOWED: Color computed from data
   <div style={{ backgroundColor: category.color }} /> // eslint-disable-line react/forbid-dom-props
   ```

3. **Database-Driven Values:**
   ```tsx
   // ✅ ALLOWED: PageStyle gradients from MongoDB
   <div style={pageStyle?.backgroundGradient ? {
     background: `linear-gradient(${pageStyle.backgroundGradient})`
   } : undefined}>
   ```

4. **Dynamic Positioning:**
   ```tsx
   // ✅ ALLOWED: Computed positioning (drag-and-drop, tooltips)
   <div style={{ 
     position: 'absolute',
     left: `${computedX}px`,
     top: `${computedY}px`
   }} /> // eslint-disable-line react/forbid-dom-props
   ```

5. **Chart Data Visualization:**
   ```tsx
   // ✅ ALLOWED: Chart colors from data series
   <div style={{ backgroundColor: series.color }} /> // eslint-disable-line react/forbid-dom-props
   ```

**Requirement:** All allowed inline styles MUST have:
- `// eslint-disable-next-line react/forbid-dom-props` comment
- `// WHAT:` comment explaining why it's dynamic
- `// WHY:` comment explaining why it cannot be in CSS

### 4.2 Explicit List: What is Forbidden

#### **FORBIDDEN (No Exceptions):**

1. **Static Colors:**
   ```tsx
   // ❌ FORBIDDEN: Static color
   <div style={{ color: '#3b82f6' }}>
   // ✅ CORRECT: Use CSS module or token
   <div className={styles.primaryText}>
   ```

2. **Static Spacing:**
   ```tsx
   // ❌ FORBIDDEN: Static spacing
   <div style={{ padding: '16px', margin: '8px' }}>
   // ✅ CORRECT: Use CSS module with tokens
   <div className={styles.container}>
   ```

3. **Static Typography:**
   ```tsx
   // ❌ FORBIDDEN: Static typography
   <p style={{ fontSize: '14px', fontWeight: 500 }}>
   // ✅ CORRECT: Use CSS module with tokens
   <p className={styles.text}>
   ```

4. **Static Layout:**
   ```tsx
   // ❌ FORBIDDEN: Static layout
   <div style={{ display: 'flex', gap: '1rem' }}>
   // ✅ CORRECT: Use utility classes or CSS module
   <div className="flex gap-4">
   ```

5. **Mixed Static/Dynamic:**
   ```tsx
   // ❌ FORBIDDEN: Mixing static and dynamic
   <div style={{ 
     backgroundColor: dynamicColor,  // dynamic
     padding: '16px',               // static - FORBIDDEN
     fontSize: '14px'               // static - FORBIDDEN
   }}>
   // ✅ CORRECT: Extract static to CSS, keep only dynamic
   <div className={styles.container} style={{ backgroundColor: dynamicColor }}>
   ```

### 4.3 Inline Style Classification Rules

**Classification Logic:**
1. **Allowed if:**
   - Uses `var(--*)` (CSS custom properties)
   - Value is computed from props/state (`props.color`, `state.x`)
   - Value comes from database (`pageStyle.color`, `style.colorScheme`)
   - Value is runtime-computed (`fontMap[selectedFont]`, `category.color`)
   - Has `eslint-disable` comment with `WHAT/WHY` explanation

2. **Forbidden if:**
   - Contains hardcoded hex colors (`#3b82f6`)
   - Contains hardcoded pixel values (`16px`, `1rem`)
   - Contains static spacing (`padding: '1rem'`)
   - Contains static typography (`fontSize: '14px'`)
   - No `eslint-disable` comment

---

## 5. Ownership Rules

### 5.1 Global Token Ownership

**Owner:** Design System Team (Chappie/Tribeca)

**Responsibilities:**
- Define new global tokens
- Maintain `app/styles/theme.css`
- Review token usage across codebase
- Approve token additions/removals
- Document token changes in RELEASE_NOTES.md

**Process for New Global Tokens:**
1. **Proposal:** Create issue/PR with:
   - Token name (following `--mm-*` convention)
   - Token value
   - Use case (2+ components)
   - Migration plan (if replacing hardcoded values)

2. **Review:** Design System Team reviews:
   - Naming convention compliance
   - Value consistency with design system
   - Impact on existing components

3. **Approval:** Chappie approves token addition

4. **Implementation:**
   - Add token to `app/styles/theme.css`
   - Update all affected components
   - Document in RELEASE_NOTES.md
   - Version bump (MINOR for new token)

### 5.2 Chart-Specific Token Ownership

**Owner:** Chart System Team (Chappie/Tribeca)

**Responsibilities:**
- Define chart-specific tokens (`--chart*`)
- Maintain chart token section in `app/styles/theme.css`
- Ensure chart tokens integrate with PageStyle system
- Review chart token usage

**Process:**
- Same as global tokens, but scope limited to chart components
- Chart tokens can reference global tokens (e.g., `--chartBackground: var(--mm-white)`)

### 5.3 Component-Scoped Token Ownership

**Owner:** Component Owner (developer who creates/maintains component)

**Responsibilities:**
- Define component-specific tokens
- Document tokens in component CSS comments
- Ensure tokens don't conflict with global tokens
- Migrate to global tokens if used in 2+ components

**Process:**
1. Create token in component CSS module
2. Document in CSS comments:
   ```css
   /**
    * TOKEN DEPENDENCIES:
    * - --component-name-property: value (component-specific)
    */
   ```
3. If token is needed in another component, propose migration to global tokens

---

## 6. How New Tokens Are Introduced

### 6.1 Token Creation Workflow

**Step 1: Identify Need**
- Hardcoded value appears in 2+ places
- New design system value needed
- Component-specific token needs to become global

**Step 2: Check Existing Tokens**
```bash
# Search for existing token
grep -r "--mm-[token-name]" app/styles/theme.css

# Check token usage
grep -r "var(--mm-[token-name])" app/ components/
```

**Step 3: Propose Token**
- Create PR with:
  - Token name (following naming convention)
  - Token value
  - Use case
  - Migration plan

**Step 4: Review & Approval**
- Design System Team reviews
- Chappie approves

**Step 5: Implementation**
- Add to `app/styles/theme.css`
- Update all affected components
- Document in RELEASE_NOTES.md
- Version bump

### 6.2 Token Naming Convention

**Format:** `--mm-[category]-[variant]-[modifier]`

**Examples:**
- `--mm-color-primary-500` (color category, primary variant, 500 shade)
- `--mm-space-4` (spacing category, 4 unit)
- `--mm-font-size-sm` (typography category, size variant, small modifier)
- `--mm-radius-lg` (border radius category, large modifier)

**Chart Tokens:** `--chart[Property]`
- `--chartBackground`
- `--chartTitleColor`
- `--kpiIconColor`

**Z-Index Tokens:** `--z-[layer]`
- `--z-base`
- `--z-modal`
- `--z-tooltip`

### 6.3 Token Deprecation Process

**When to Deprecate:**
- Token is no longer used
- Token is replaced by new token
- Token conflicts with design system update

**Process:**
1. Mark token as deprecated in `app/styles/theme.css`:
   ```css
   /* DEPRECATED: Use --mm-color-primary-600 instead */
   --mm-color-primary-old: #2563eb;
   ```

2. Update all usages to new token
3. Remove deprecated token after migration complete
4. Document in RELEASE_NOTES.md
5. Version bump (MAJOR if breaking change)

---

## 7. Migration Rules

### 7.1 Hardcoded Value Migration

**Rule:** All hardcoded values MUST be migrated to tokens before remediation is considered complete.

**Migration Steps:**
1. Identify hardcoded value in inventory
2. Check if token exists in `app/styles/theme.css`
3. If token exists: Replace hardcoded value with token
4. If token doesn't exist: Propose new token (follow token creation workflow)
5. Update component CSS or create CSS module
6. Test visual regression
7. Document in commit message

**Example:**
```css
/* Before */
.component {
  color: #3b82f6;
  padding: 16px;
}

/* After */
.component {
  color: var(--mm-color-primary-500);
  padding: var(--mm-space-4);
}
```

### 7.2 Inline Style Migration

**Rule:** All forbidden inline styles MUST be migrated to CSS modules.

**Migration Steps:**
1. Identify forbidden inline style in inventory
2. Extract static styles to CSS module
3. Keep only dynamic values in inline style (with eslint-disable)
4. Apply CSS module class to component
5. Test visual regression
6. Document in commit message

**Example:**
```tsx
/* Before */
<div style={{ 
  display: 'flex',
  gap: '1rem',
  padding: '16px',
  backgroundColor: dynamicColor
}}>

/* After */
// Component CSS module
.container {
  display: flex;
  gap: var(--mm-space-4);
  padding: var(--mm-space-4);
}

// Component TSX
<div className={styles.container} style={{ backgroundColor: dynamicColor }}> // eslint-disable-line react/forbid-dom-props
```

---

## 8. Acceptance Criteria

### 8.1 Token System Compliance

**All of the following MUST be true:**
- ✅ No hardcoded hex colors (except in `app/styles/theme.css` token definitions)
- ✅ No hardcoded pixel values for spacing (except `0`)
- ✅ No hardcoded typography values
- ✅ All colors use `var(--mm-color-*)` or `var(--chart*)`
- ✅ All spacing uses `var(--mm-space-*)`
- ✅ All typography uses `var(--mm-font-*)`
- ✅ All border radius uses `var(--mm-radius-*)`
- ✅ All shadows use `var(--mm-shadow-*)`

### 8.2 Inline Style Compliance

**All of the following MUST be true:**
- ✅ No forbidden inline styles (static values)
- ✅ All allowed inline styles have `eslint-disable` comment
- ✅ All allowed inline styles have `WHAT/WHY` comments
- ✅ All static styles moved to CSS modules
- ✅ All dynamic styles properly documented

### 8.3 Ownership Compliance

**All of the following MUST be true:**
- ✅ All global tokens defined in `app/styles/theme.css`
- ✅ All component-scoped tokens documented in component CSS
- ✅ No component-scoped tokens used in 2+ components
- ✅ All new tokens follow naming convention
- ✅ All token changes documented in RELEASE_NOTES.md

### 8.4 Regression Prevention

**Guardrails:**
- ✅ ESLint rule: `react/forbid-dom-props` with `style` forbidden
- ✅ Pre-commit hook: Check for hardcoded hex colors
- ✅ CI/CD: Grep check for hardcoded pixel values
- ✅ Code review: Reject PRs with hardcoded values or forbidden inline styles

---

## 9. Next Steps

**After Approval:**
1. Update audit plan tracker: Mark P0 3.3 as APPROVED
2. Begin P0 3.1 remediation: Migrate hardcoded values to tokens
3. Begin P0 3.2 remediation: Migrate forbidden inline styles to CSS modules
4. Implement guardrails: ESLint rules, pre-commit hooks, CI/CD checks

**Status:** ⏳ Awaiting approval from Chappie

---

## 10. References

- **Design System:** `docs/design/DESIGN_SYSTEM.md`
- **Theme Tokens:** `app/styles/theme.css`
- **Coding Standards:** `CODING_STANDARDS.md`
- **Hardcoded Values Inventory:** `docs/audits/hardcoded-values-inventory.csv`
- **Inline Styles Inventory:** `docs/audits/inline-styles-inventory.csv`
