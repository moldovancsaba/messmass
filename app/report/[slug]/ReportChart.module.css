/* WHAT: ReportChart Component Styles (v12.0.0)
 * WHY: Clean, token-based styling for all chart types
 * HOW: CSS modules with design tokens from theme.css
 */

/* Base Chart Container */
.chart {
  /* WHAT: Flexbox container for consistent internal layout */
  display: flex;
  flex-direction: column;
  width: 100% !important; /* WHAT: Fill parent gridItem horizontally (CRITICAL FIX) */
  max-width: none !important; /* CRITICAL: Remove any max-width constraints */
  height: 100% !important; /* CRITICAL: Fill parent row height (deterministic) */
  flex: 1 1 auto; /* CRITICAL: Allow chart to grow and fill space */
  /* REMOVED: min-height - row height is deterministic from block calculator */
  
  /* WHAT: Visual styling - uses custom chart colors */
  background: var(--chart-bg) !important;
  border-radius: var(--mm-radius-lg);
  box-shadow: var(--mm-shadow-sm);
  padding: 0; /* WHAT: Remove padding, add to header/body instead */
  overflow: hidden; /* WHAT: Prevent content overflow */
  box-sizing: border-box !important;
  /* Enable container queries for inner scaling (width + height) */
  container-type: size;
  /* REMOVED: transition - interferes with container query recalculation */
}

/* Chart Header - Titles and metadata */
.chartHeader {
  padding: var(--mm-space-4) var(--mm-space-5);
  border-bottom: 1px solid var(--chart-border);
  flex-shrink: 0; /* WHAT: Prevent header from shrinking */
}

/* Chart Body - Main content area */
.chartBody {
  flex: 1; /* WHAT: Expand to fill available space */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  padding: var(--mm-space-2);
  min-height: 0; /* WHAT: Allow flex shrinking if needed */
}

/* Chart Title - Standardized across all types */
.chartTitle {
  /* Scale title to container width: min 0.9rem, grows with box, caps at 1.25rem */
  font-size: clamp(0.9rem, 2.8cqw, 1.25rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chart-title-color);
  margin: 0;
  line-height: 1.2;
  text-align: center; /* WHAT: Center align chart titles */
}

/* No Data State */
.noData {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%; /* Fill parent height */
  background: var(--chart-nodata-bg);
  border: 2px dashed var(--chart-nodata-border);
}

.noDataContent {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--mm-space-2);
  color: var(--chart-nodata-text);
}

.noDataIcon {
  font-size: var(--mm-font-size-3xl);
  opacity: 0.5;
}

.noDataText {
  font-size: var(--mm-font-size-base);
  font-weight: var(--mm-font-weight-medium);
}

.noDataLabel {
  font-size: var(--mm-font-size-sm);
  color: var(--chart-nodata-text);
}

/* KPI Chart - 3-row grid: Icon (30%), Value (40%), Label (30%) */
.kpi {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.kpi .chartBody {
  display: flex;
  flex-direction: column;
  flex: 1;
  height: 100%;
  padding: 0;
}

.kpiContent {
  display: grid;
  grid-template-rows: 3fr 4fr 3fr;
  height: 100%;
  width: 100%;
  gap: 0;
}

.kpiIconRow {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  /* WHAT: Enable container queries so icon can size relative to THIS row */
  /* WHY: Icon needs to query its immediate parent, not the whole chart */
  container-type: size;
}

.kpiIcon {
  /* WHAT: Material Icons scale by font-size, not SVG dimensions */
  /* WHY: Switched from Lucide (SVG) to Material Icons (font) */
  /* HOW: Now queries .kpiIconRow container for 90% fill */
  /* CONSTRAINT: Unconstrained - allow maximum scaling for visual impact (2rem → 6rem = 3x) */
  font-size: clamp(2rem, 90cqh, 6rem) !important; /* 90% of icon row height - !important overrides MaterialIcon inline styles */
  height: auto !important;
  width: auto !important;
  color: var(--kpi-icon-color) !important; /* WHAT: Use custom KPI icon color from style */
  line-height: 1 !important; /* WHAT: Prevent extra vertical spacing */
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.kpi .kpiValue {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  /* CONSTRAINT: Unconstrained - allow maximum scaling for visual impact (1.5rem → 6rem = 4x) */
  font-size: clamp(1.5rem, min(20cqh, 25cqw), 6rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chart-value-color);
  line-height: 0.85;
  text-align: center;
  letter-spacing: -0.04em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.kpi .kpiTitle {
  /* WHAT: 30% text height of 30cqh row, 10% line spacing, max 2 lines */
  /* WHY: More breathing room, no overflow, centered */
  /* HOW: 9cqh font (30% of 30cqh), line-height 1.1 (10% spacing) */
  /* CONSTRAINT: 1.5x max ratio (0.75rem → 1.125rem = 12px → 18px) for visual consistency */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;
  height: 100%;
  font-size: clamp(0.75rem, 9cqh, 1.125rem);
  font-weight: var(--mm-font-weight-medium);
  color: var(--chart-label-color);
  line-height: 1.1;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: keep-all;
  overflow-wrap: break-word;
  hyphens: none;
  padding: var(--mm-space-2);
}

/* Pie Chart - Uses base .chart structure */
.pie .chartBody {
  padding: var(--mm-space-3);
  display: flex;
  flex-direction: column;
  gap: var(--mm-space-2);
}

.pieTitle {
  font-size: clamp(0.9rem, 2.6cqw, 1.2rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chart-title-color);
  margin-bottom: var(--mm-space-1);
  text-align: center;
}

.pieSegments {
  display: flex;
  gap: var(--mm-space-1);
  justify-content: center;
}

.pieSegment {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--mm-space-2);
}

.pieColor {
  width: 32px;
  height: 32px;
  border-radius: var(--mm-radius-full);
  box-shadow: var(--mm-shadow-sm);
}

.pieLabel {
  font-size: clamp(0.7rem, 2cqw, 0.9rem);
  color: var(--chart-label-color);
  font-weight: var(--mm-font-weight-medium);
}

.pieValue {
  font-size: clamp(1rem, 3cqw, 1.4rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chart-value-color);
}

.piePercent {
  font-size: var(--mm-font-size-sm);
  color: var(--chart-label-color);
}

/* Pie Chart Container for Chart.js */
.pieChartContainer {
  flex: 0 0 70%; /* WHAT: Pie takes 70% of body height */
  width: 100%;
  height: 70%; /* CRITICAL: Explicit height for Chart.js */
  position: relative;
}

/* Custom Pie Legend - 30% of body height */
.pieLegend {
  flex: 0 0 30%; /* WHAT: Legend takes 30% of body height */
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: var(--mm-space-1);
  width: 100%;
}

.pieLegendItem {
  display: flex;
  align-items: center;
  gap: var(--mm-space-2);
  width: 100%;
}

.pieLegendDot {
  /* WHAT: Circle size with border matching pie slices */
  width: 4.5cqh;
  height: 4.5cqh;
  border-radius: 50%;
  flex-shrink: 0;
  /* WHAT: Border using primary theme color (same as pie chart) */
  border: 2px solid var(--chart-color-1, var(--mm-color-error-800));
  box-sizing: border-box;
}

.pieLegendText {
  /* WHAT: Calculate based on legend row height (30cqh legend / 2 items = 15cqh per row) */
  /* WHY: Same pattern as bar labels - 30% of allocated row space */
  font-size: 4.5cqh;
  font-weight: var(--mm-font-weight-medium);
  color: var(--chart-label-color);
  line-height: 1.1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Bar Chart - Uses base .chart structure */
.bar .chartBody {
  padding: var(--mm-space-2);
  display: flex; /* CRITICAL: Enable flex layout */
  flex-direction: column; /* CRITICAL: Stack content vertically */
  flex: 1; /* CRITICAL: Fill available vertical space */
  min-height: 0; /* CRITICAL: Allow flex shrinking */
}

.barTitle {
  font-size: clamp(0.9rem, 2.6cqw, 1.2rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chart-title-color);
  margin-bottom: var(--mm-space-1);
  flex-shrink: 0; /* WHAT: Prevent title from shrinking */
}

.barElements {
  display: flex;
  flex-direction: column;
  gap: 0;
  flex: 1; /* CRITICAL: Fill ALL remaining vertical space */
  justify-content: space-evenly; /* WHAT: Distribute bars evenly across full height */
  width: 100%; /* CRITICAL: Fill full chart width */
  max-width: none !important; /* CRITICAL: Remove max-width */
  min-height: 0; /* CRITICAL: Allow flex shrinking */
}

.barRow {
  display: grid;
  /* WHAT: Fixed ratio - 40% label, 40% bar, 20% value */
  /* WHY: Balanced space for label and bar, more room for value */
  grid-template-columns: 40% 40% 20%;
  gap: 0 var(--mm-space-1);
  align-items: center;
  flex: 1;
  padding: 0 var(--mm-space-1);
}

.barLabel {
  /* WHAT: Bar label - 45% of bar height with 10% line spacing */
  /* WHY: Proportional to bar, readable with 2-line wrapping */
  /* CONSTRAINT: 1.2x max ratio (0.75rem → 0.9rem = 12px → 14.4px) for tight consistency */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  align-items: center;
  justify-content: flex-end;
  padding-right: var(--mm-space-2);
  font-size: clamp(0.75rem, 4.95cqh, 0.9rem);
  color: var(--chart-label-color);
  font-weight: var(--mm-font-weight-medium);
  text-align: right;
  line-height: 1.1;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: keep-all;
  overflow-wrap: break-word;
  hyphens: none;
}

.barTrack {
  background: var(--chart-nodata-bg);
  /* WHAT: 11% of cell height, max 50% of cell width, semicircular ends
   * WHY: Centralized system - no hardcoded pixels, responsive to cell size
   * HOW: 11cqh height constrained to 1.2x ratio for tight consistency */
  /* CONSTRAINT: 1.2x max ratio (0.6rem → 0.72rem = 9.6px → 11.5px) for tight consistency */
  height: clamp(0.6rem, 11cqh, 0.72rem);
  max-width: 50cqw;
  border-radius: calc(clamp(0.6rem, 11cqh, 0.72rem) / 2); /* WHAT: 50% of bar height for semicircular ends */
  overflow: hidden;
}

.barFill {
  height: 100%;
  border-radius: calc(clamp(0.6rem, 11cqh, 0.72rem) / 2); /* WHAT: Match track radius (50% of bar height) for seamless pill shape */
  transition: width var(--transition-normal);
}

.barValue {
  /* WHAT: Bar value - always 50% of bar height (5.5cqh) */
  /* WHY: Proportional to bar across all chart dimensions */
  /* CONSTRAINT: 1.2x max ratio (0.875rem → 1.05rem = 14px → 16.8px) for tight consistency */
  display: flex;
  align-items: center;
  justify-content: flex-start;
  height: clamp(0.6rem, 11cqh, 0.72rem); /* Match bar track height */
  padding-left: var(--mm-space-2);
  font-size: clamp(0.875rem, 5.5cqh, 1.05rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chart-value-color);
  text-align: left;
  line-height: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Text Chart - Uses base .chart structure */
.text {
  /* REMOVED: min-height - height is deterministic from block calculator */
}

.text .chartBody {
  /* WHAT: Center text and fill space */
  align-items: center;
  justify-content: center;
  padding: var(--mm-space-4); /* More padding for better visual breathing */
}

.textTitle {
  font-size: clamp(0.95rem, 2.6cqw, 1.25rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chart-title-color);
  margin-bottom: 0;
}

.textContent {
  /* WHAT: Maximize font size to fill cell while staying readable */
  /* WHY: Text content should dominate the space like KPI values */
  /* HOW: Use container queries to scale based on both width and height */
  /* CONSTRAINT: 1.5x max ratio (1rem → 1.5rem = 16px → 24px) for visual consistency */
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;
  height: 100%;
  font-size: clamp(1rem, min(8cqh, 6cqw), 1.5rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chart-value-color);
  line-height: 1.3;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  padding: var(--mm-space-2);
}

/* Image Chart - SIMPLIFIED */
.image {
  background: var(--chart-bg) !important;
  border-radius: var(--mm-radius-lg); /* Rounded corners for image container */
  box-shadow: var(--mm-shadow-sm);
  overflow: hidden !important; /* Clip image to rounded corners */
  /* Inherits height: 100% from base .chart - fills row */
}

/* WHAT: <img> element fills container and crops to fit */
/* WHY: object-fit: cover fills container completely while maintaining aspect ratio */
/* HOW: Image covers entire container, cropped to fit with centered position */
.imageContent {
  display: block;
  width: 100%;
  height: 100%; /* Fill the .image container */
  object-fit: cover; /* Fill container, crop as needed to maintain aspect ratio */
  object-position: center; /* Center the cropped image */
  border-radius: var(--mm-radius-lg); /* Match container rounded corners */
}

/* VALUE Composite Chart */
.valueComposite {
  display: flex;
  flex-direction: column;
  gap: var(--mm-space-4);
}

/* Unknown Chart Type */
.unknown {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%; /* Fill parent height */
  background: var(--chart-error-bg);
  color: var(--chart-error-text);
  font-size: var(--mm-font-size-sm);
  font-weight: var(--mm-font-weight-medium);
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .pieSegments {
    flex-direction: column;
    gap: var(--mm-space-4);
  }
  
  .barRow {
    /* WHAT: Same rem-based columns as desktop - fully responsive
     * WHY: No hardcoded pixels, consistent design token system */
    grid-template-columns: minmax(5rem, 22cqw) 1fr minmax(3.75rem, 16cqw);
    gap: var(--mm-space-2);
  }
  
  .barLabel {
    font-size: var(--mm-font-size-xs);
  }
  
  /* WHAT: Force explicit height on all non-image charts in mobile */
  /* WHY: aspect-ratio can break document flow, use explicit min-height */
  .chart:not(.image) {
    min-height: 250px !important; /* Explicit minimum height */
    height: auto !important;
    width: 100% !important;
    max-height: none !important;
    flex: none !important;
    position: relative !important; /* Ensure normal document flow */
    overflow: hidden !important;
  }
  
  /* WHAT: Image charts maintain their natural aspect ratio on mobile */
  /* WHY: Images shouldn't be forced into 2:1, respect original dimensions */
  .image {
    height: auto !important;
    min-height: 250px !important; /* Ensure images are visible */
    position: relative !important;
  }
  
  .imageContent {
    /* WHAT: Show full image with natural aspect ratio */
    height: 100% !important;
    width: 100% !important;
    object-fit: contain !important; /* Show full image on mobile */
    max-height: none !important;
  }
}
