/* WHAT: ReportChart Component Styles (v12.0.0)
 * WHY: Clean, token-based styling for all chart types
 * HOW: CSS modules with design tokens from theme.css
 */

/* Base Chart Container */
.chart {
  /* WHAT: Flexbox container for consistent internal layout */
  display: flex;
  flex-direction: column;
  width: 100% !important; /* WHAT: Fill parent gridItem horizontally (CRITICAL FIX) */
  max-width: none !important; /* CRITICAL: Remove any max-width constraints */
  height: 100% !important; /* CRITICAL: Fill parent row height (deterministic) */
  flex: 1 1 auto; /* CRITICAL: Allow chart to grow and fill space */
  /* REMOVED: min-height - row height is deterministic from block calculator */
  
  /* UNIFIED NAMING: --chartBackground matches database property */
  background: var(--chartBackground) !important;
  border-radius: var(--mm-radius-lg);
  box-shadow: var(--mm-shadow-sm);
  padding: 0; /* WHAT: Remove padding, add to header/body instead */
  overflow: hidden; /* WHAT: Prevent content overflow */
  box-sizing: border-box !important;
  /* Enable container queries for inner scaling (width + height) */
  container-type: size;
  /* REMOVED: transition - interferes with container query recalculation */
}

/* Chart Header - Titles and metadata */
.chartHeader {
  padding: var(--mm-space-4) var(--mm-space-5);
  border-bottom: 1px solid var(--chartBorder);
  flex-shrink: 0; /* WHAT: Prevent header from shrinking */
}

/* Chart Body - Main content area */
.chartBody {
  flex: 1; /* WHAT: Expand to fill available space */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  padding: var(--mm-space-2);
  min-height: 0; /* WHAT: Allow flex shrinking if needed */
}

/* Chart Title - Standardized across all types */
.chartTitle {
  /* Scale title to container width: min 0.9rem, grows with box, caps at 1.25rem */
  font-size: clamp(0.9rem, 2.8cqw, 1.25rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chartTitleColor);
  margin: 0;
  line-height: 1.2;
  text-align: center; /* WHAT: Center align chart titles */
}

/* No Data State */
.noData {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%; /* Fill parent height */
  background: var(--chartNoDataBackground);
  border: 2px dashed var(--chartNoDataBorder);
}

.noDataContent {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--mm-space-2);
  color: var(--chartNoDataText);
}

.noDataIcon {
  font-size: var(--mm-font-size-3xl);
  opacity: 0.5;
}

.noDataText {
  font-size: var(--mm-font-size-base);
  font-weight: var(--mm-font-weight-medium);
}

.noDataLabel {
  font-size: var(--mm-font-size-sm);
  color: var(--chartNoDataText);
}

/* KPI Chart - 3-row grid: Icon (30%), Value (40%), Title (30%) */
.kpi {
  /* WHAT: Full height cell with internal 3-row grid */
  /* WHY: Title MUST be inside grid to maintain 3fr-4fr-3fr proportions */
  /* HOW: Remove CellWrapper title, use internal grid rows */
  height: 100%;
  display: grid;
  grid-template-rows: 3fr 4fr 3fr; /* Icon:Value:Title = 30%:40%:30% */
  gap: 0;
  width: 100%;
  box-sizing: border-box;
}

.kpi .chartBody {
  /* WHAT: Body takes full height - grid layout handled by .kpi */
  /* WHY: No flex needed, grid handles all sizing */
  display: contents; /* CRITICAL: Pass grid layout through to children */
}

.kpiContent {
  /* WHAT: Content wrapper for icon + value (rows 1-2) */
  /* WHY: Flex layout for vertical stacking within grid */
  display: flex;
  flex-direction: column;
  gap: 0;
  /* CRITICAL: Spans first two grid rows via CSS Grid flow */
  /* Using auto-placement, items fill rows 1-2 */
}

.kpiIconRow {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  /* WHAT: Enable container queries so icon can size relative to THIS row */
  /* WHY: Icon needs to query its immediate parent, not the whole chart */
  container-type: size;
}

.kpiIcon {
  /* WHAT: Material Icons scale by font-size, not SVG dimensions */
  /* WHY: Switched from Lucide (SVG) to Material Icons (font) */
  /* HOW: Now queries .kpiIconRow container for 90% fill */
  /* CONSTRAINT: Unconstrained - allow maximum scaling for visual impact (2rem → 6rem = 3x) */
  font-size: clamp(2rem, 90cqh, 6rem) !important; /* 90% of icon row height - !important overrides MaterialIcon inline styles */
  height: auto !important;
  width: auto !important;
  color: var(--kpiIconColor) !important; /* WHAT: Use custom KPI icon color from style */
  line-height: 1 !important; /* WHAT: Prevent extra vertical spacing */
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

.kpi .kpiValue {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  /* CONSTRAINT: Unconstrained - allow maximum scaling for visual impact (1.5rem → 6rem = 4x) */
  font-size: clamp(1.5rem, min(20cqh, 25cqw), 6rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chartValueColor);
  line-height: 0.85;
  text-align: center;
  letter-spacing: -0.04em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.kpi .kpiTitle {
  /* WHAT: 3rd grid row (30%) - title at bottom of KPI */
  /* WHY: Grid row 3 = bottom 30% of cell */
  /* HOW: Text centered within 3fr row using flex */
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  width: 100%;
  height: 100%;
  padding: var(--mm-space-2);
  /* Font scales based on container height (3fr row) */
  font-size: clamp(0.75rem, 9cqh, 1.125rem);
  font-weight: var(--mm-font-weight-medium);
  color: var(--chartLabelColor);
  line-height: 1.1;
  overflow: hidden;
  /* Max 2 lines with ellipsis */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  word-break: break-word;
  hyphens: none;
}

/* Pie Chart - Uses base .chart structure */
.pie .chartBody {
  /* WHAT: No padding - let body fill entire cell */
  /* WHY: Pie container gets fixed 70% height regardless of cell size */
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 0; /* Fixed gap - pies align regardless of title length */
  height: 100%;
  /* WHAT: Enable container queries for proper sizing */
  container-type: size;
}

.pieTitle {
  font-size: clamp(0.9rem, 2.6cqw, 1.2rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chartTitleColor);
  margin-bottom: var(--mm-space-1);
  text-align: center;
}

.pieSegments {
  display: flex;
  gap: var(--mm-space-1);
  justify-content: center;
}

.pieSegment {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--mm-space-2);
}

.pieColor {
  width: 32px;
  height: 32px;
  border-radius: var(--mm-radius-full);
  box-shadow: var(--mm-shadow-sm);
}

.pieLabel {
  font-size: clamp(0.7rem, 2cqw, 0.9rem);
  color: var(--chartLabelColor);
  font-weight: var(--mm-font-weight-medium);
}

.pieValue {
  font-size: clamp(1rem, 3cqw, 1.4rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chartValueColor);
}

.piePercent {
  font-size: var(--mm-font-size-sm);
  color: var(--chartLabelColor);
}

/* Pie Chart Container for Chart.js - CRITICAL for alignment */
.pieChartContainer {
  /* WHAT: Fixed 70% height container for pie chart */
  /* WHY: Ensures all pies align vertically regardless of cell content variance */
  height: 70%; /* FIXED: Always 70% of cell height */
  width: 100%;
  position: relative;
  /* WHAT: Center pie within container */
  display: flex;
  align-items: center;
  justify-content: center;
  /* WHAT: Container queries for responsive sizing */
  container-type: size;
}

/* Custom Pie Legend - 30% of body height - CRITICAL for alignment */
.pieLegend {
  /* WHAT: Fixed 30% height container for legend */
  /* WHY: Ensures consistent layout regardless of text length */
  height: 30%; /* FIXED: Always 30% of cell height */
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: var(--mm-space-1);
  width: 100%;
  /* WHAT: Container queries for text scaling */
  container-type: size;
}

.pieLegendItem {
  display: flex;
  align-items: center;
  gap: var(--mm-space-2);
  width: 100%;
}

.pieLegendDot {
  /* WHAT: Circle size with border matching pie slices */
  /* WHY: Use legend container height for consistent sizing */
  /* HOW: 45% of legend height (based on 2 items per legend) */
  width: 4.5cqh;
  height: 4.5cqh;
  border-radius: 50%;
  flex-shrink: 0;
  /* WHAT: Default color fallback */
  border: 2px solid var(--mm-color-primary-500);
  box-sizing: border-box;
}

.pieLegendText {
  /* WHAT: Text scales with legend container height */
  /* WHY: 45% of legend height ensures readable text at all sizes */
  font-size: clamp(0.7rem, 4.5cqh, 1rem);
  font-weight: var(--mm-font-weight-medium);
  color: var(--chartLabelColor);
  line-height: 1.1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Bar Chart - Uses base .chart structure */
.bar .chartBody {
  padding: var(--mm-space-2);
  display: flex; /* CRITICAL: Enable flex layout */
  flex-direction: column; /* CRITICAL: Stack content vertically */
  flex: 1; /* CRITICAL: Fill available vertical space */
  min-height: 0; /* CRITICAL: Allow flex shrinking */
}

.barTitle {
  font-size: clamp(0.9rem, 2.6cqw, 1.2rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chartTitleColor);
  margin-bottom: var(--mm-space-1);
  flex-shrink: 0; /* WHAT: Prevent title from shrinking */
}

.barElements {
  display: flex;
  flex-direction: column;
  gap: 0;
  flex: 1; /* CRITICAL: Fill ALL remaining vertical space */
  justify-content: space-evenly; /* WHAT: Distribute bars evenly across full height */
  width: 100%; /* CRITICAL: Fill full chart width */
  max-width: none !important; /* CRITICAL: Remove max-width */
  min-height: 0; /* CRITICAL: Allow flex shrinking */
}

.barRow {
  display: grid;
  /* WHAT: Fixed ratio - 40% label, 40% bar, 20% value */
  /* WHY: Balanced space for label and bar, more room for value */
  /* HOW: Use CSS Grid with proportional sizing - NO viewport mixing */
  grid-template-columns: 40% 40% 20%;
  gap: 0 var(--mm-space-1);
  align-items: center;
  flex: 1;
  padding: 0 var(--mm-space-1);
  /* WHAT: Enable container queries for proper responsive sizing */
  container-type: size;
}

.barLabel {
  /* WHAT: Bar label - 45% of bar height with 10% line spacing */
  /* WHY: Proportional to bar, readable with 2-line wrapping */
  /* CONSTRAINT: 1.2x max ratio (0.75rem → 0.9rem = 12px → 14.4px) for tight consistency */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
  align-items: center;
  justify-content: flex-end;
  padding-right: var(--mm-space-2);
  /* WHAT: Use container query height ONLY, not width mixing */
  /* WHY: Container query ensures consistent scaling across cell sizes */
  font-size: clamp(0.75rem, 4.95cqh, 0.9rem);
  color: var(--chartLabelColor);
  font-weight: var(--mm-font-weight-medium);
  text-align: right;
  line-height: 1.1;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: keep-all;
  overflow-wrap: break-word;
  hyphens: none;
}

.barTrack {
  background: var(--chartNoDataBackground);
  /* WHAT: 11% of cell height, max 80% of cell width, semicircular ends
   * WHY: Use full container width, not mixing viewport queries
   * HOW: 11cqh height constrained to 1.2x ratio for tight consistency */
  /* CONSTRAINT: 1.2x max ratio (0.6rem → 0.72rem = 9.6px → 11.5px) for tight consistency */
  height: clamp(0.6rem, 11cqh, 0.72rem);
  /* WHAT: Use 80% of available container width (label 40% + track 40% + value 20%) */
  /* WHY: Grid gives us 40% for track, no need for max-width restriction */
  width: 100%; /* Use full grid column width, no restrictions */
  border-radius: calc(clamp(0.6rem, 11cqh, 0.72rem) / 2); /* WHAT: 50% of bar height for semicircular ends */
  overflow: hidden;
}

.barFill {
  height: 100%;
  border-radius: calc(clamp(0.6rem, 11cqh, 0.72rem) / 2); /* WHAT: Match track radius (50% of bar height) for seamless pill shape */
  transition: width var(--transition-normal);
}

.barValue {
  /* WHAT: Bar value - always 50% of bar height (5.5cqh) */
  /* WHY: Proportional to bar across all chart dimensions */
  /* CONSTRAINT: 1.2x max ratio (0.875rem → 1.05rem = 14px → 16.8px) for tight consistency */
  display: flex;
  align-items: center;
  justify-content: flex-start;
  height: clamp(0.6rem, 11cqh, 0.72rem); /* Match bar track height */
  padding-left: var(--mm-space-2);
  font-size: clamp(0.875rem, 5.5cqh, 1.05rem);
  font-weight: var(--mm-font-weight-bold);
  color: var(--chartValueColor);
  text-align: left;
  line-height: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Text Chart - Uses base .chart structure */
.text {
  /* REMOVED: min-height - height is deterministic from block calculator */
}

.text .chartBody {
  /* WHAT: Center text and fill space */
  align-items: center;
  justify-content: center;
  padding: var(--mm-space-4); /* More padding for better visual breathing */
}

.textTitle {
  font-size: clamp(0.95rem, 2.6cqw, 1.25rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--chartTitleColor);
  margin-bottom: 0;
}

.textContent {
  /* WHAT: Maximize font size to fill cell while staying readable */
  /* WHY: Text content should dominate the space like KPI values */
  /* HOW: Use container queries to scale based on both width and height */
  /* CONSTRAINT: 1.5x max ratio (1rem → 1.5rem = 16px → 24px) for visual consistency */
  display: block;
  text-align: center;
  width: 100%;
  height: 100%;
  font-size: clamp(1rem, min(8cqh, 6cqw), 1.5rem);
  font-weight: var(--mm-font-weight-semibold);
  color: var(--textColor);
  line-height: 1.3;
  padding: var(--mm-space-2);
}

/* WHAT: Markdown element styles inside text content
 * WHY: Support limited markdown features: title, bold, italic, lists, links
 * HOW: Use relative font sizes (em) so they inherit container scaling
 */
.textMarkdown h1 {
  margin: 0 0 0.25em 0;
  font-weight: 700;
  line-height: 1.2;
  font-size: 1.15em; /* Single title size, slightly larger */
}

.textMarkdown p {
  margin: 0 0 0.5em 0;
}

.textMarkdown strong { font-weight: 700; }
.textMarkdown em { font-style: italic; }

.textMarkdown ul,
.textMarkdown ol {
  margin: 0.25em 0 0.5em 0;
  padding-left: 1.5em; /* indent markers */
  text-align: left; /* lists read better left-aligned */
  display: inline-block; /* keep centered within overall centered layout */
}

.textMarkdown li { margin: 0.15em 0; }

.textMarkdown a { color: var(--mm-blue-600); text-decoration: underline; }
.textMarkdown a:hover { color: var(--mm-blue-700); }

/* Image Chart - SIMPLIFIED */
.image {
  background: var(--chartBackground) !important;
  border-radius: var(--mm-radius-lg); /* Rounded corners for image container */
  box-shadow: var(--mm-shadow-sm);
  overflow: hidden !important; /* Clip image to rounded corners */
  /* Inherits height: 100% from base .chart - fills row */
}

/* WHAT: <img> element fills container and crops to fit */
/* WHY: object-fit: cover fills container completely while maintaining aspect ratio */
/* HOW: Image covers entire container, cropped to fit with centered position */
.imageContent {
  display: block;
  width: 100%;
  height: 100%; /* Fill the .image container */
  object-fit: cover; /* Fill container, crop as needed to maintain aspect ratio */
  object-position: center; /* Center the cropped image */
  border-radius: var(--mm-radius-lg); /* Match container rounded corners */
}

/* VALUE Composite Chart */
.valueComposite {
  display: flex;
  flex-direction: column;
  gap: var(--mm-space-4);
}

/* Unknown Chart Type */
.unknown {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%; /* Fill parent height */
  background: var(--chartErrorBackground);
  color: var(--chartErrorText);
  font-size: var(--mm-font-size-sm);
  font-weight: var(--mm-font-weight-medium);
}

/* Special Cases: CellWrapper + Chart Combinations */
/* WHAT: CellWrapper breaks container query inheritance */
/* WHY: Charts need separate container-type for proper sizing */

/* CellWrapper + KPI Chart - No longer needed (KPI grid handles sizing) */

/* CellWrapper + Pie Chart */
.CellWrapper_bodyZone__ps_rO .pieChartContainer {
  /* WHAT: Fixed 70% height regardless of wrapper */
  height: 70%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.CellWrapper_bodyZone__ps_rO .pieLegend {
  /* WHAT: Fixed 30% height regardless of wrapper */
  height: 30%;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/* CellWrapper + Bar Chart */
.CellWrapper_bodyZone__ps_rO .barRow {
  /* WHAT: Container queries for bar sizing inside wrapper */
  container-type: size;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .pieSegments {
    flex-direction: column;
    gap: var(--mm-space-4);
  }
  
  .barRow {
    /* WHAT: Same rem-based columns as desktop - fully responsive
     * WHY: No hardcoded pixels, consistent design token system */
    grid-template-columns: minmax(5rem, 22cqw) 1fr minmax(3.75rem, 16cqw);
    gap: var(--mm-space-2);
  }
  
  .barLabel {
    font-size: var(--mm-font-size-xs);
  }
  
  /* WHAT: Charts must scale to fit their container on mobile
   * WHY: Prevent overflow - charts must behave same as desktop (scale and fit)
   * HOW: Maintain flexbox fill behavior, ensure container queries work properly */
  .chart:not(.image) {
    width: 100% !important;
    height: 100% !important; /* CRITICAL: Fill parent container */
    min-height: 250px !important; /* Minimum readable size */
    max-width: 100% !important;
    flex: 1 1 auto !important; /* Allow flex filling */
    overflow: hidden !important; /* Prevent content overflow */
    box-sizing: border-box !important;
    container-type: size; /* Ensure container queries work on mobile */
  }
  
  /* WHAT: Image charts respect aspect ratio on mobile
   * WHY: Images must maintain proper proportions without distortion
   * HOW: Use aspect-ratio CSS property for reliable sizing */
  .image {
    width: 100% !important;
    height: auto !important; /* Let aspect-ratio determine height */
    min-height: 0 !important; /* Remove min-height constraint */
    max-width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
  }
  
  /* WHAT: Aspect ratio classes for image containers on mobile */
  .image.aspect169 {
    aspect-ratio: 16 / 9;
  }
  
  .image.aspect916 {
    aspect-ratio: 9 / 16;
  }
  
  .image.aspect11 {
    aspect-ratio: 1 / 1;
  }
  
  .imageContent {
    /* WHAT: Image fills container maintaining aspect ratio
     * WHY: object-fit: cover ensures image fills space without distortion
     * HOW: Same behavior as desktop - consistent across breakpoints */
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important; /* Fill container, crop to maintain ratio */
    object-position: center !important;
    display: block !important;
  }
}
